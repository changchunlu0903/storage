<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>âœ¨ æ¢¨æ¢¨çš„ç™¾å®ç®± (å®‰å…¨ç‰ˆ) âœ¨</title>
    <style>
        /* --- å¼•å…¥å®šåˆ¶å­—ä½“ --- */
        @font-face {
            font-family: 'MyCustomFont';
            src: url('https://files.catbox.moe/cweam3.ttf') format('truetype');
            font-display: swap;
        }

        :root {
            --primary-color: #ffb7c5;
            --secondary-color: #ffe6eb;
            --accent-color: #ff8fa3;
            --text-color: #6d5c5c;
            --radius: 20px;
            --shadow: 0 8px 24px rgba(255, 183, 197, 0.4);
            --lock-bg: #fff0f5;
        }

        body {
            font-family: 'MyCustomFont', 'Microsoft YaHei', sans-serif;
            background-color: var(--secondary-color);
            color: var(--text-color);
            margin: 0;
            padding: 0; /* ä¿®æ”¹ä¸º0ï¼Œç”±å†…éƒ¨å®¹å™¨æ§åˆ¶padding */
            overflow-x: hidden;
            height: 100vh;
        }

        /* ==================== ğŸŒ¸ æ¨±èŠ±ç‰¹æ•ˆ & é”å±æ ·å¼ ==================== */
        
        #lockScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff5f7; z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background-image: radial-gradient(#fff 2px, transparent 2px);
            background-size: 30px 30px;
        }

        /* é£˜è½æ¨±èŠ± */
        .sakura {
            position: absolute; background: #ffc0cb; border-radius: 100% 0 100% 0; opacity: 0.5;
            animation: fall linear infinite; pointer-events: none;
        }
        @keyframes fall {
            0% { transform: translate(0, -10vh) rotate(0deg); opacity: 1; }
            100% { transform: translate(100px, 110vh) rotate(360deg); opacity: 0; }
        }

        /* é€šç”¨å¡ç‰‡æ ·å¼ */
        .lock-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            padding: 40px 30px;
            width: 85%; max-width: 400px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(255, 183, 197, 0.3);
            border: 2px solid #fff;
            position: relative;
            z-index: 10;
            transition: transform 0.3s;
        }

        .lock-title { font-size: 24px; color: var(--accent-color); margin-bottom: 10px; font-weight: bold; }
        .lock-subtitle { color: #999; font-size: 14px; margin-bottom: 30px; line-height: 1.6; }

        /* æ¬¢è¿é¡µç‰¹å®šæ ·å¼ (å¤åˆ»å›¾ç‰‡) */
        .welcome-btn {
            display: block; width: 100%; padding: 18px; border-radius: 50px;
            margin-bottom: 15px; border: none; font-size: 16px; color: white;
            font-family: inherit; cursor: pointer; font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); transition: transform 0.2s;
        }
        .welcome-btn:active { transform: scale(0.98); }
        .btn-gesture { background: #ffb7c5; }
        .btn-pin { background: linear-gradient(90deg, #a8edea 0%, #ffb7c5 100%); }

        /* æ•°å­—é”®ç›˜æ ·å¼ */
        .pin-display {
            display: flex; justify-content: center; gap: 15px; margin-bottom: 30px;
        }
        .pin-dot {
            width: 16px; height: 16px; border-radius: 50%;
            background: #eee; border: 2px solid #ddd; transition: all 0.2s;
        }
        .pin-dot.active { background: var(--accent-color); border-color: var(--accent-color); transform: scale(1.2); }
        
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; max-width: 280px; margin: 0 auto; }
        .num-btn {
            width: 60px; height: 60px; border-radius: 50%; border: none;
            background: #fff; color: var(--text-color); font-size: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); cursor: pointer;
            font-family: inherit; display: flex; align-items: center; justify-content: center;
        }
        .num-btn:active { background: var(--secondary-color); }

        /* æ‰‹åŠ¿å›¾æ¡ˆæ ·å¼ */
        .gesture-container { position: relative; width: 300px; height: 300px; margin: 0 auto; touch-action: none; }
        .gesture-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; }
        .gesture-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr);
            width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 1;
        }
        .gesture-point {
            display: flex; align-items: center; justify-content: center;
        }
        .point-inner {
            width: 18px; height: 18px; background: #ddd; border-radius: 50%;
            transition: 0.3s;
        }
        .point-inner.active { background: var(--accent-color); box-shadow: 0 0 0 10px rgba(255, 143, 163, 0.2); }

        /* è¡¨å•è¾“å…¥æ¡† */
        .lock-input {
            width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #ffe6eb;
            border-radius: 12px; text-align: center; font-family: inherit;
            outline: none; color: var(--text-color);
        }
        .lock-input:focus { border-color: var(--accent-color); }

        .back-link {
            margin-top: 20px; font-size: 13px; color: #bbb; cursor: pointer; text-decoration: underline;
        }

        /* æ¶ˆæ¯æç¤º */
        .toast {
            position: fixed; top: 50px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); color: white; padding: 10px 20px;
            border-radius: 30px; font-size: 14px; opacity: 0; pointer-events: none;
            transition: opacity 0.3s; z-index: 20000;
        }

        /* ==================== åŸæœ‰ CSS (åŠ äº† app-container ä½œç”¨åŸŸ) ==================== */
        #appContainer {
            display: none; /* é»˜è®¤éšè—ï¼Œè§£é”åæ˜¾ç¤º */
            padding: 20px;
            padding-bottom: 100px;
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        h1 { text-align: center; color: var(--accent-color); font-weight: normal; margin: 10px 0 30px 0; text-shadow: 2px 2px 0px #fff; font-size: 32px; }

        /* --- ğŸ¶ æ‚¬æµ®çª— --- */
        .float-widget { position: fixed; bottom: 30px; right: 30px; z-index: 9999; touch-action: none; }
        .float-btn {
            width: 48px; height: 48px; border-radius: 50%;
            background: #fff; border: 3px solid var(--primary-color);
            box-shadow: 0 5px 15px rgba(255, 117, 143, 0.3);
            display: flex; justify-content: center; align-items: center;
            font-size: 24px; cursor: move; user-select: none;
            transition: transform 0.1s; position: relative;
        }
        .float-btn:active { transform: scale(0.9); }
        .float-btn::after { content: 'ğŸ¶'; }
        
        .float-menu {
            position: absolute; bottom: 60px; right: 0;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            border-radius: 20px; width: 260px; padding: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); border: 2px solid #fff;
            transform-origin: bottom right; transform: scale(0); opacity: 0;
            transition: all 0.2s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            pointer-events: none; max-height: 60vh; display: flex; flex-direction: column;
        }
        .float-menu.active { transform: scale(1); opacity: 1; pointer-events: auto; }

        .music-panel { background: var(--secondary-color); border-radius: 15px; padding: 12px; margin-bottom: 15px; text-align: center; }
        .music-controls { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 8px; }
        .play-btn { background: var(--accent-color); color: white; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .nav-panel { flex-grow: 1; overflow-y: auto; }
        .nav-title { font-weight: bold; color: var(--accent-color); margin-bottom: 8px; border-bottom: 1px dashed #ddd; }
        
        /* --- å¡ç‰‡ä¸å¸ƒå±€ --- */
        .search-container { max-width: 600px; margin: 0 auto 30px auto; position: relative; }
        .search-input { width: 100%; padding: 15px 50px 15px 25px; border: 2px solid #fff; border-radius: 50px; background: rgba(255, 255, 255, 0.9); font-size: 16px; outline: none; font-family: inherit; }
        .search-input:focus { border-color: var(--primary-color); }
        .search-icon { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); color: var(--primary-color); }

        .controls { display: flex; justify-content: center; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; }
        button { background: #fff; border: 2px solid var(--primary-color); color: var(--accent-color); padding: 8px 18px; border-radius: 50px; cursor: pointer; font-family: inherit; font-size: 14px; transition: all 0.2s; display: flex; align-items: center; gap: 5px; }
        button:hover { background: var(--primary-color); color: white; transform: translateY(-2px); }
        button.primary-btn { background: var(--accent-color); color: white; border: none; }

        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; max-width: 1200px; margin: 0 auto; }
        .card { background: #fff; border-radius: var(--radius); overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.05); transition: transform 0.3s; border: 3px solid #fff; display: flex; flex-direction: column; cursor: pointer; position: relative; }
        .card:hover { transform: translateY(-5px); border-color: var(--primary-color); }
        .card-img-wrapper { height: 200px; background-color: #fcecef; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; }
        .card img { width: 100%; height: 100%; object-fit: cover; }
        
        .content-indicators { position: absolute; top: 8px; left: 8px; display: flex; gap: 4px; flex-wrap: wrap; }
        .indicator { background: rgba(255,255,255,0.95); padding: 2px 6px; border-radius: 6px; font-size: 12px; color: var(--text-color); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        .card-content { padding: 10px; flex-grow: 1; display: flex; flex-direction: column; }
        .card-title { font-size: 18px; margin: 0 0 5px 0; color: var(--text-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .tags-container { display: flex; flex-wrap: wrap; gap: 4px; margin-top: auto; }
        .tag-pill { background: var(--secondary-color); color: var(--accent-color); font-size: 12px; padding: 2px 6px; border-radius: 8px; }

        /* --- å¼¹çª— --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 240, 245, 0.85); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-overlay.active { display: flex; }
        .modal { background: white; padding: 25px; border-radius: 25px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 15px 40px rgba(255, 130, 150, 0.2); position: relative; }
        .close-modal { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 28px; cursor: pointer; color: #ccc; }

        /* ...ä¿ç•™åŸæœ‰çš„å…¶ä»–CSS... */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 16px; color: var(--accent-color); }
        input[type="text"], select { width: 100%; padding: 10px; border: 2px solid var(--secondary-color); border-radius: 12px; outline: none; box-sizing: border-box; background: #fff; font-family: inherit; font-size: 15px; }
        
        .tag-input-area { border: 2px solid var(--secondary-color); border-radius: 12px; padding: 8px; display: flex; flex-wrap: wrap; gap: 5px; min-height: 40px; }
        .tag-input-area input { border: none; outline: none; flex-grow: 1; padding: 5px; font-family: inherit; }
        .tag-chip { background: var(--primary-color); color: white; padding: 3px 8px; border-radius: 10px; font-size: 14px; display: flex; gap: 5px; align-items: center; }

        .resource-list { border: 1px solid #eee; border-radius: 12px; padding: 10px; max-height: 200px; overflow-y: auto; background: #fafafa; }
        .resource-item { display: flex; align-items: center; gap: 10px; background: white; padding: 8px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #f0f0f0; }
        .resource-preview { width: 40px; height: 40px; border-radius: 5px; object-fit: cover; background: #eee; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 20px;}
        .resource-info { flex-grow: 1; min-width: 0; }
        .resource-name { font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .resource-type-select { font-size: 12px; padding: 2px; border: 1px solid #ddd; border-radius: 4px; margin-top: 2px; font-family: inherit; }
        .btn-remove { background: #ffdede; color: #ff6b6b; border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; font-weight: bold; }

        .add-btn-row { display: flex; gap: 10px; margin-top: 5px; }
        .small-btn { font-size: 14px; padding: 5px 12px; }

        .gallery-container { position: relative; width: 100%; height: 320px; background: #fafafa; border-radius: 15px; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; border: 1px solid #eee; flex-direction: column;}
        .gallery-img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .gallery-type-label { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.6); color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; z-index: 10; }
        
        .gallery-nav { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.8); border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); user-select: none; z-index: 10; }
        .nav-prev { left: 10px; } .nav-next { right: 10px; }
        .cover-btn { position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.9); border: 2px solid var(--accent-color); color: var(--accent-color); font-size: 12px; padding: 4px 10px; cursor: pointer; border-radius: 20px; z-index: 10; font-family: inherit; }
        .cover-btn.is-cover { background: var(--accent-color); color: white; }
        .download-img-btn { position: absolute; bottom: 10px; right: 10px; background: rgba(255,255,255,0.9); border: 2px solid var(--primary-color); color: var(--primary-color); width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 10; transition: all 0.2s;}
        
        .detail-list { margin-top: 10px; }
        .detail-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px dashed #eee; font-size: 14px; }
        .detail-item-type { background: #f0f0f0; padding: 2px 6px; border-radius: 4px; color: #888; margin-right: 5px; font-size: 12px; }
        
        .action-link { 
            color: var(--accent-color); text-decoration: none; cursor: pointer; font-weight: bold; font-size: 12px;
            background: #fff0f3; padding: 4px 8px; border-radius: 4px; transition: background 0.2s;
        }
        .action-link:hover { background: var(--primary-color); color: white; }

        .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .empty-state { grid-column: 1 / -1; text-align: center; color: #cea0a9; padding: 50px; font-size: 18px; }
        .edit-btn { background: #fff8e1; border-color: #ffc107; color: #ffb300; }
        
        input[type="file"] { display: none; }
    </style>
</head>
<body>

    <div id="lockScreen">
        <div id="sakuraContainer"></div>

        <div id="view-welcome" class="lock-card" style="display:none;">
            <div style="font-size:40px; margin-bottom:10px;">ğŸŒ¸</div>
            <div class="lock-title">æ¬¢è¿æ¥åˆ°ä½ çš„ç™¾å®ç®±</div>
            <div class="lock-subtitle">ç¬¬ä¸€æ¬¡æ¥ï¼Œå…ˆç»™è‡ªå·±æŒ‘ä¸€æŠŠé’¥åŒ™å§ï¼</div>
            
            <button class="welcome-btn btn-gesture" onclick="auth.startSetup('gesture')">æˆ‘æ˜¯æ‰‹åŠ¿æ§ (è¿çº¿è§£é”)</button>
            <button class="welcome-btn btn-pin" onclick="auth.startSetup('pin')">æˆ‘æ˜¯æ•°å­—æ§ (PINç è§£é”)</button>
        </div>

        <div id="view-setup-question" class="lock-card" style="display:none;">
            <div class="lock-title">ğŸ” å®‰å…¨ä¿éšœ</div>
            <div class="lock-subtitle">ä¸‡ä¸€å¿˜äº†å¯†ç ï¼Œè¿™ä¸ªå¯ä»¥æ•‘ä½ ï¼</div>
            
            <div class="form-group" style="text-align:left;">
                <label>è®¾ç½®ä¸€ä¸ªå®‰å…¨é—®é¢˜</label>
                <input type="text" id="secQuestion" class="lock-input" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„ç¬¬ä¸€åªå® ç‰©æ˜¯ï¼Ÿ">
            </div>
            <div class="form-group" style="text-align:left;">
                <label>é—®é¢˜çš„ç­”æ¡ˆ</label>
                <input type="text" id="secAnswer" class="lock-input" placeholder="è¾“å…¥ç­”æ¡ˆ">
            </div>
            
            <button class="welcome-btn btn-gesture" onclick="auth.saveSecurityQuestion()">å®Œæˆè®¾ç½®</button>
        </div>

        <div id="view-pin" class="lock-card" style="display:none;">
            <div class="lock-title" id="pinTitle">è¯·è¾“å…¥å¯†ç </div>
            <div class="lock-subtitle" id="pinSub">è¾“å…¥4ä½æ•°å­—å¯†ç </div>
            
            <div class="pin-display" id="pinDots">
                <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
            </div>
            
            <div class="numpad">
                <button class="num-btn" onclick="auth.inputPin(1)">1</button>
                <button class="num-btn" onclick="auth.inputPin(2)">2</button>
                <button class="num-btn" onclick="auth.inputPin(3)">3</button>
                <button class="num-btn" onclick="auth.inputPin(4)">4</button>
                <button class="num-btn" onclick="auth.inputPin(5)">5</button>
                <button class="num-btn" onclick="auth.inputPin(6)">6</button>
                <button class="num-btn" onclick="auth.inputPin(7)">7</button>
                <button class="num-btn" onclick="auth.inputPin(8)">8</button>
                <button class="num-btn" onclick="auth.inputPin(9)">9</button>
                <div></div>
                <button class="num-btn" onclick="auth.inputPin(0)">0</button>
                <button class="num-btn" style="color:#ff6b6b" onclick="auth.clearPin()">ğŸ”™</button>
            </div>
            <div class="back-link" id="pinForgotBtn" onclick="auth.showRecovery()" style="display:none">å¿˜è®°å¯†ç ï¼Ÿ</div>
        </div>

        <div id="view-gesture" class="lock-card" style="display:none;">
            <div class="lock-title" id="gestTitle">ç»˜åˆ¶å›¾æ¡ˆ</div>
            <div class="lock-subtitle" id="gestSub">è¯·ç»˜åˆ¶ä½ çš„è§£é”å›¾æ¡ˆ</div>
            
            <div class="gesture-container" id="gestureArea">
                <div class="gesture-grid">
                    <div class="gesture-point"><div class="point-inner" data-idx="0"></div></div>
                    <div class="gesture-point"><div class="point-inner" data-idx="1"></div></div>
                    <div class="gesture-point"><div class="point-inner" data-idx="2"></div></div>
                    <div class="gesture-point"><div class="point-inner" data-idx="3"></div></div>
                    <div class="gesture-point"><div class="point-inner" data-idx="4"></div></div>
                    <div class="gesture-point"><div class="point-inner" data-idx="5"></div></div>
                    <div class="gesture-point"><div class="point-inner" data-idx="6"></div></div>
                    <div class="gesture-point"><div class="point-inner" data-idx="7"></div></div>
                    <div class="gesture-point"><div class="point-inner" data-idx="8"></div></div>
                </div>
                <canvas id="gestureCanvas" width="300" height="300"></canvas>
            </div>
            <div class="back-link" id="gestForgotBtn" onclick="auth.showRecovery()" style="display:none">å¿˜è®°å¯†ç ï¼Ÿ</div>
            <div class="back-link" id="gestResetBtn" onclick="auth.resetGesture()" style="display:none">é‡ç»˜</div>
        </div>

        <div id="view-recovery" class="lock-card" style="display:none;">
            <div class="lock-title">ğŸ˜Ÿ å¿˜è®°å¯†ç äº†ï¼Ÿ</div>
            <div class="lock-subtitle" id="recoveryQText">å›ç­”ä½ çš„å®‰å…¨é—®é¢˜</div>
            
            <input type="text" id="recoveryAnswer" class="lock-input" placeholder="è¾“å…¥ç­”æ¡ˆ">
            <button class="welcome-btn btn-gesture" onclick="auth.checkRecovery()">éªŒè¯</button>
            <div class="back-link" onclick="location.reload()">è¿”å›</div>
        </div>
    </div>

    <div id="toast" class="toast">æç¤ºä¿¡æ¯</div>

    <div id="appContainer">
        <h1>ğŸŒ¸ æˆ‘çš„ç™¾å®ç®± v7.0 ğŸŒ¸</h1>

        <div class="float-widget" id="floatWidget">
            <div class="float-menu" id="floatMenu">
                <div class="music-panel">
                    <div style="font-size:12px; color:#aaa; margin-bottom:5px;">ğŸ§ èƒŒæ™¯éŸ³ä¹</div>
                    <div class="music-controls">
                        <button class="play-btn" onclick="toggleMusic()" id="playBtn">â–¶</button>
                        <input type="range" min="0" max="1" step="0.1" value="0.5" onchange="changeVolume(this)" style="width:60px; accent-color:var(--accent-color)">
                    </div>
                    <input type="text" style="width:100%;font-size:10px;padding:4px;border:1px solid #ddd;border-radius:5px;" id="musicLink" placeholder="è¾“å…¥mp3é“¾æ¥..." onchange="updateMusicSrc(this.value)">
                    <audio id="bgMusic" loop></audio>
                </div>
                <div class="nav-panel" id="navPanel">
                    <div class="nav-title">ğŸ·ï¸ å¿«é€Ÿè·³è½¬</div>
                </div>
            </div>
            <div class="float-btn" id="floatBtn"></div>
        </div>

        <div class="search-container">
            <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢åç§°æˆ–æ ‡ç­¾..." oninput="handleSearch()">
            <span class="search-icon">ğŸ”</span>
        </div>

        <div class="controls">
            <button onclick="openAddModal()" class="primary-btn"><span>â•</span> æ·»åŠ ç´ æ</button>
            <button onclick="exportAllData()"><span>ğŸ’¾</span> å¤‡ä»½å…¨éƒ¨</button>
            <button onclick="document.getElementById('importAllInput').click()"><span>ğŸ“‚</span> å¯¼å…¥å¤‡ä»½</button>
            <input type="file" id="importAllInput" accept=".json" onchange="importAllData(this)">
        </div>

        <div class="grid-container" id="gridContainer">
            <div class="empty-state">æ­£åœ¨åˆå§‹åŒ–æ•°æ®åº“... ğŸ’¾</div>
        </div>
    </div>

    <div class="modal-overlay" id="addModal">
        <div class="modal">
            <button class="close-modal" onclick="closeAddModal()">Ã—</button>
            <h2 id="modalTitle">âœ¨ æ·»åŠ æ–°æ”¶è—</h2>
            
            <div class="form-group">
                <label>ğŸ’– åå­—</label>
                <input type="text" id="itemName" placeholder="ç»™è¿™ä¸ªç›’å­èµ·ä¸ªåå­—...">
            </div>

            <div class="form-group">
                <label>ğŸ·ï¸ æ ‡ç­¾ (å›è½¦æ·»åŠ )</label>
                <div class="tag-input-area" id="tagInputArea" onclick="document.getElementById('tagInput').focus()">
                    <input type="text" id="tagInput" onkeydown="handleTagInput(event)">
                </div>
                <div id="suggestedTags" style="margin-top:5px; display:flex; gap:5px; flex-wrap:wrap;"></div>
            </div>

            <div class="form-group">
                <label>ğŸ“¦ åŒ…å«çš„æ–‡ä»¶ä¸é“¾æ¥</label>
                <div class="resource-list" id="resourceList">
                    <div style="text-align:center; color:#ccc; font-size:12px; padding:20px;">æš‚æ— å†…å®¹ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ </div>
                </div>

                <div class="add-btn-row">
                    <label class="upload-area small-btn">
                        ğŸ–¼ï¸ åŠ å›¾ç‰‡
                        <input type="file" accept="image/*" multiple onchange="handleImageSelect(this)">
                    </label>
                    <label class="upload-area small-btn">
                        ğŸ“„ åŠ JSON
                        <input type="file" accept=".json,application/json" multiple onchange="handleJsonSelect(this)">
                    </label>
                    <button class="small-btn" onclick="openLinkInput()">ğŸ”— åŠ é“¾æ¥</button>
                </div>
                
                <div id="linkInputArea" style="display:none; margin-top:10px; background:#f9f9f9; padding:10px; border-radius:10px;">
                    <input type="text" id="newLinkName" placeholder="é“¾æ¥åç§° (å¦‚: ä½œè€…ä¸»é¡µ)" style="margin-bottom:5px;">
                    <input type="text" id="newLinkUrl" placeholder="ç½‘å€ (http://...)" style="margin-bottom:5px;">
                    <div style="text-align:right;">
                        <button class="small-btn" onclick="confirmAddLink()">ç¡®å®š</button>
                        <button class="small-btn" style="background:#eee; color:#666; border:none" onclick="document.getElementById('linkInputArea').style.display='none'">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>

            <div class="modal-buttons">
                <button onclick="closeAddModal()">å–æ¶ˆ</button>
                <button class="primary-btn" onclick="saveItem()">ğŸ’¾ ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="detailModal">
        <div class="modal">
            <button class="close-modal" onclick="closeDetailModal()">Ã—</button>
            <h2 id="detailName" style="text-align:center; margin-bottom:5px;"></h2>
            <div id="detailTags" style="display:flex; justify-content:center; gap:5px; margin-bottom:15px;"></div>

            <div id="galleryArea">
                <div class="gallery-container">
                    <div class="gallery-type-label" id="galleryTypeLabel">ç±»å‹</div>
                    <img id="detailImg" class="gallery-img" src="">
                    <div class="gallery-nav nav-prev" onclick="changeGalleryImage(-1)">â®</div>
                    <div class="gallery-nav nav-next" onclick="changeGalleryImage(1)">â¯</div>
                    
                    <button id="setCoverBtn" class="cover-btn" onclick="setAsCover()">è®¾ä¸ºå°é¢</button>
                    <button class="download-img-btn" onclick="downloadCurrentGalleryImg()" title="ä¸‹è½½æ­¤å›¾">â¬‡ï¸</button>
                    <div style="position:absolute; bottom:10px; left:10px; background:rgba(0,0,0,0.5); color:white; padding:2px 8px; border-radius:10px; font-size:12px; pointer-events:none;">
                        <span id="imgIndex">1</span> / <span id="imgTotal">1</span>
                    </div>
                </div>
            </div>
            <div id="noImgMsg" style="text-align:center; color:#ccc; padding:20px; display:none;">(æ­¤ç›’å­æ²¡æœ‰å›¾ç‰‡)</div>

            <div class="form-group">
                <label>ğŸ“‚ ç›’å­å†…å®¹</label>
                <div id="detailListContainer" class="detail-list"></div>
            </div>

            <div class="modal-buttons" style="justify-content: center; flex-wrap:wrap;">
                <button class="edit-btn" onclick="openEditMode()">âœï¸ ç¼–è¾‘ç›’å­å†…å®¹</button>
                <button onclick="deleteCurrentItem()" style="border-color: #ffcccc; color: #ff6b6b;">ğŸ—‘ï¸ åˆ é™¤ç›’å­</button>
            </div>
        </div>
    </div>

    <script>
        // ================= ğŸ”’ å®‰å…¨ç³»ç»Ÿé€»è¾‘ (AuthSystem) =================
        
        const auth = {
            mode: 'login', // login, setup, verify
            type: null,    // pin, gesture
            step: 0,       // for setup confirmation
            tempSecret: null,
            inputBuffer: '',
            failCount: 0,
            
            init: function() {
                // ç”Ÿæˆæ¨±èŠ±
                this.createSakura();
                
                // æ£€æŸ¥æ˜¯å¦æœ‰å­˜å‚¨çš„å¯†ç 
                const savedType = localStorage.getItem('magic_auth_type');
                const savedSecret = localStorage.getItem('magic_auth_secret');
                
                if (!savedType || !savedSecret) {
                    this.showView('view-welcome');
                } else {
                    this.mode = 'login';
                    this.type = savedType;
                    if (this.type === 'pin') this.showView('view-pin');
                    else this.showView('view-gesture');
                    
                    // æ‰‹åŠ¿éœ€è¦åˆå§‹åŒ–Canvasç›‘å¬
                    if (this.type === 'gesture') setTimeout(() => this.initGesture(), 100);
                }
            },

            createSakura: function() {
                const container = document.getElementById('sakuraContainer');
                for(let i=0; i<15; i++) {
                    const el = document.createElement('div');
                    el.className = 'sakura';
                    el.style.left = Math.random() * 100 + '%';
                    el.style.animationDuration = (Math.random() * 5 + 5) + 's';
                    el.style.animationDelay = Math.random() * 5 + 's';
                    container.appendChild(el);
                }
            },

            showView: function(id) {
                ['view-welcome', 'view-pin', 'view-gesture', 'view-setup-question', 'view-recovery'].forEach(v => {
                    document.getElementById(v).style.display = 'none';
                });
                document.getElementById(id).style.display = 'block';
                if(id === 'view-pin') this.updatePinDots();
            },

            toast: function(msg) {
                const t = document.getElementById('toast');
                t.textContent = msg; t.style.opacity = 1;
                setTimeout(() => t.style.opacity = 0, 2000);
            },

            // --- æµç¨‹æ§åˆ¶ ---
            startSetup: function(type) {
                this.mode = 'setup';
                this.type = type;
                this.step = 1;
                this.inputBuffer = '';
                
                if (type === 'pin') {
                    document.getElementById('pinTitle').textContent = 'è®¾ç½®å¯†ç ';
                    document.getElementById('pinSub').textContent = 'è¯·è¾“å…¥4ä½æ–°å¯†ç ';
                    this.showView('view-pin');
                } else {
                    document.getElementById('gestTitle').textContent = 'ç»˜åˆ¶å›¾æ¡ˆ';
                    document.getElementById('gestSub').textContent = 'è¯·ç»˜åˆ¶è§£é”å›¾æ¡ˆ';
                    this.showView('view-gesture');
                    setTimeout(() => this.initGesture(), 100);
                }
            },

            // --- æ•°å­—å¯†ç é€»è¾‘ ---
            inputPin: function(num) {
                if (this.inputBuffer.length < 4) {
                    this.inputBuffer += num;
                    this.updatePinDots();
                    if (this.inputBuffer.length === 4) {
                        setTimeout(() => this.submitPin(), 200);
                    }
                }
            },
            clearPin: function() {
                this.inputBuffer = '';
                this.updatePinDots();
            },
            updatePinDots: function() {
                const dots = document.getElementById('pinDots').children;
                for(let i=0; i<4; i++) {
                    if(i < this.inputBuffer.length) dots[i].classList.add('active');
                    else dots[i].classList.remove('active');
                }
            },
            submitPin: function() {
                const val = this.inputBuffer;
                this.inputBuffer = '';
                this.updatePinDots();

                if (this.mode === 'setup') {
                    if (this.step === 1) {
                        this.tempSecret = val;
                        this.step = 2;
                        document.getElementById('pinTitle').textContent = 'å†æ¬¡ç¡®è®¤';
                        document.getElementById('pinSub').textContent = 'è¯·å†æ¬¡è¾“å…¥ä»¥ç¡®è®¤';
                    } else {
                        if (val === this.tempSecret) {
                            this.finishPasswordSetup(val);
                        } else {
                            this.toast('ä¸¤æ¬¡è¾“å…¥ä¸ä¸€è‡´ï¼Œè¯·é‡è¯•');
                            this.step = 1;
                            document.getElementById('pinTitle').textContent = 'è®¾ç½®å¯†ç ';
                        }
                    }
                } else if (this.mode === 'login') {
                    if (val === localStorage.getItem('magic_auth_secret')) {
                        this.unlockApp();
                    } else {
                        this.handleFail();
                    }
                }
            },

            // --- æ‰‹åŠ¿å¯†ç é€»è¾‘ ---
            initGesture: function() {
                const canvas = document.getElementById('gestureCanvas');
                const ctx = canvas.getContext('2d');
                const area = document.getElementById('gestureArea');
                let isDrawing = false;
                let path = []; // å­˜å‚¨ç‚¹ç´¢å¼• [0,1,2...]

                const getPoint = (x, y) => {
                    const rect = area.getBoundingClientRect();
                    const rx = x - rect.left;
                    const ry = y - rect.top;
                    // ç®€å•åˆ¤å®šï¼š3x3ç½‘æ ¼
                    const col = Math.floor(rx / (300/3));
                    const row = Math.floor(ry / (300/3));
                    if(col>=0 && col<3 && row>=0 && row<3) return row*3 + col;
                    return -1;
                };

                const draw = (curX, curY) => {
                    ctx.clearRect(0, 0, 300, 300);
                    ctx.strokeStyle = '#ffb7c5';
                    ctx.lineWidth = 4;
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                    
                    if(path.length > 0) {
                        ctx.beginPath();
                        const p0 = getCenter(path[0]);
                        ctx.moveTo(p0.x, p0.y);
                        for(let i=1; i<path.length; i++) {
                            const p = getCenter(path[i]);
                            ctx.lineTo(p.x, p.y);
                        }
                        if(curX !== null) ctx.lineTo(curX, curY);
                        ctx.stroke();
                    }
                    
                    // é«˜äº®åœ†ç‚¹
                    document.querySelectorAll('.point-inner').forEach((el, i) => {
                        if(path.includes(i)) el.classList.add('active');
                        else el.classList.remove('active');
                    });
                };

                const getCenter = (idx) => {
                    const row = Math.floor(idx/3), col = idx%3;
                    return { x: col*100 + 50, y: row*100 + 50 };
                };

                const start = (e) => {
                    e.preventDefault();
                    isDrawing = true;
                    path = [];
                    move(e);
                };

                const move = (e) => {
                    if(!isDrawing) return;
                    e.preventDefault();
                    const touch = e.touches ? e.touches[0] : e;
                    const rect = canvas.getBoundingClientRect();
                    const x = touch.clientX - rect.left;
                    const y = touch.clientY - rect.top;
                    
                    const idx = getPoint(touch.clientX, touch.clientY);
                    if(idx !== -1 && !path.includes(idx)) {
                        path.push(idx);
                    }
                    draw(x, y);
                };

                const end = () => {
                    if(!isDrawing) return;
                    isDrawing = false;
                    draw(null, null); // æ¸…é™¤æ‹–å°¾
                    
                    if(path.length < 3) {
                        this.toast('è¿æ¥çš„ç‚¹å¤ªå°‘å•¦');
                        path = []; draw(null,null);
                        return;
                    }
                    
                    const code = path.join('');
                    if(this.mode === 'setup') {
                        if(this.step === 1) {
                            this.tempSecret = code;
                            this.step = 2;
                            document.getElementById('gestTitle').textContent = 'å†æ¬¡ç»˜åˆ¶';
                            document.getElementById('gestSub').textContent = 'è¯·å†æ¬¡ç»˜åˆ¶ä»¥ç¡®è®¤';
                            document.getElementById('gestResetBtn').style.display = 'block';
                            setTimeout(()=>{ path=[]; draw(null,null); }, 500);
                        } else {
                            if(code === this.tempSecret) {
                                this.finishPasswordSetup(code);
                            } else {
                                this.toast('ä¸¤æ¬¡ç»˜åˆ¶ä¸ä¸€è‡´');
                                this.step = 1;
                                document.getElementById('gestTitle').textContent = 'ç»˜åˆ¶å›¾æ¡ˆ';
                                setTimeout(()=>{ path=[]; draw(null,null); }, 500);
                            }
                        }
                    } else if(this.mode === 'login') {
                        if(code === localStorage.getItem('magic_auth_secret')) {
                            this.unlockApp();
                        } else {
                            this.handleFail();
                            setTimeout(()=>{ path=[]; draw(null,null); }, 500);
                        }
                    }
                };

                // ç»‘å®šäº‹ä»¶
                canvas.addEventListener('mousedown', start);
                canvas.addEventListener('mousemove', move);
                document.addEventListener('mouseup', end);
                canvas.addEventListener('touchstart', start, {passive:false});
                canvas.addEventListener('touchmove', move, {passive:false});
                canvas.addEventListener('touchend', end);

                this.resetGesture = () => {
                    this.step = 1; this.tempSecret = null;
                    document.getElementById('gestTitle').textContent = 'ç»˜åˆ¶å›¾æ¡ˆ';
                    document.getElementById('gestSub').textContent = 'è¯·ç»˜åˆ¶è§£é”å›¾æ¡ˆ';
                    document.getElementById('gestResetBtn').style.display = 'none';
                    path = []; draw(null,null);
                };
            },

            // --- å…±åŒé€»è¾‘ ---
            finishPasswordSetup: function(secret) {
                // æš‚æ—¶ä¿å­˜ï¼Œè·³è½¬åˆ°å®‰å…¨é—®é¢˜
                this.finalSecret = secret;
                this.finalType = this.type;
                this.showView('view-setup-question');
            },

            saveSecurityQuestion: function() {
                const q = document.getElementById('secQuestion').value.trim();
                const a = document.getElementById('secAnswer').value.trim();
                if(!q || !a) { this.toast('è¯·å¡«å†™å®Œæ•´å“¦'); return; }

                localStorage.setItem('magic_auth_type', this.finalType);
                localStorage.setItem('magic_auth_secret', this.finalSecret);
                localStorage.setItem('magic_auth_q', q);
                localStorage.setItem('magic_auth_a', a);
                
                this.toast('è®¾ç½®æˆåŠŸï¼ä¸‹æ¬¡è¯·ä½¿ç”¨å¯†ç ç™»å½•');
                this.unlockApp();
            },

            handleFail: function() {
                this.failCount++;
                this.toast('å¯†ç é”™è¯¯');
                document.querySelectorAll('.lock-card').forEach(c => {
                    c.style.transform = 'translateX(10px)';
                    setTimeout(() => c.style.transform = 'translateX(-10px)', 100);
                    setTimeout(() => c.style.transform = 'translateX(0)', 200);
                });
                
                if(this.failCount >= 3) {
                    if(this.type==='pin') document.getElementById('pinForgotBtn').style.display='block';
                    else document.getElementById('gestForgotBtn').style.display='block';
                }
            },

            showRecovery: function() {
                const q = localStorage.getItem('magic_auth_q');
                if(!q) { this.toast('æœªè®¾ç½®å®‰å…¨é—®é¢˜ï¼Œæ— æ³•æ‰¾å›'); return; }
                document.getElementById('recoveryQText').textContent = q;
                this.showView('view-recovery');
            },

            checkRecovery: function() {
                const ans = document.getElementById('recoveryAnswer').value.trim();
                if(ans === localStorage.getItem('magic_auth_a')) {
                    // éªŒè¯æˆåŠŸï¼Œæ¸…é™¤æ‰€æœ‰å¯†ç è®¾ç½®ï¼Œé‡å›é¦–é¡µ
                    localStorage.removeItem('magic_auth_type');
                    localStorage.removeItem('magic_auth_secret');
                    this.toast('éªŒè¯æˆåŠŸï¼Œè¯·é‡æ–°è®¾ç½®å¯†ç ');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    this.toast('ç­”æ¡ˆé”™è¯¯');
                }
            },

            unlockApp: function() {
                const lock = document.getElementById('lockScreen');
                lock.style.transition = 'opacity 0.5s';
                lock.style.opacity = 0;
                setTimeout(() => {
                    lock.style.display = 'none';
                    document.getElementById('appContainer').style.display = 'block';
                    // è§¦å‘åŸæœ‰åˆå§‹åŒ–
                    if(!window.appInitialized) {
                        initOriginalApp();
                        window.appInitialized = true;
                    }
                }, 500);
            }
        };


        // ================= ğŸ“± åŸæœ‰åº”ç”¨é€»è¾‘ (å°è£…) =================
        let items = [];
        let draftResources = []; 
        let currentTags = [];
        let isEditing = false;
        let editingIndex = -1;
        let viewingIndex = -1;
        let galleryIndex = 0;

        const TYPES = ['é»˜è®¤', 'äººç‰©å¡', 'ä¸–ç•Œä¹¦', 'QRç ', 'é¢„è®¾', 'é¢„è®¾æ­£åˆ™', 'æ’ä»¶'];
        const PLACEHOLDER_IMG = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23ffe6eb'/%3E%3Ctext x='50' y='50' fill='%23ffb7c5' text-anchor='middle' dy='.3em'%3Eæ— å›¾%3C/text%3E%3C/svg%3E";
        const DEFAULT_MUSIC = "https://files.catbox.moe/btptsb.mp3";
        const DB_NAME = 'MyMagicDB';
        const STORE_NAME = 'items';
        let db;

        // é¡µé¢åŠ è½½å…¥å£
        window.onload = function() {
            auth.init(); // å…ˆå¯åŠ¨å®‰å…¨ç³»ç»Ÿ
        };

        // åªæœ‰è§£é”åæ‰è°ƒç”¨æ­¤å‡½æ•°
        function initOriginalApp() {
            initDB().then(() => {
                loadFromDB();
                migrateFromLocalStorage();
            });
            initMusic();
            initDraggable();
        }

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 1);
                request.onerror = (e) => { console.error("Database error", e); reject(); };
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                    }
                };
                request.onsuccess = (e) => {
                    db = e.target.result;
                    resolve();
                };
            });
        }

        async function loadFromDB() {
            const tx = db.transaction(STORE_NAME, 'readonly');
            const store = tx.objectStore(STORE_NAME);
            const request = store.getAll();
            request.onsuccess = () => {
                items = request.result.sort((a, b) => new Date(b.date) - new Date(a.date));
                renderGrid(items);
                renderNavPanel();
            };
        }

        async function saveItemToDB(item) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_NAME, 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                let req;
                if(item.id) req = store.put(item); 
                else req = store.add(item); 
                req.onsuccess = () => { resolve(req.result); };
                req.onerror = () => { alert('ä¿å­˜å¤±è´¥ï¼Œå¯èƒ½æ˜¯æ–‡ä»¶å¤ªå¤§äº†ï¼Ÿ'); reject(); };
            });
        }

        async function deleteItemFromDB(id) {
            const tx = db.transaction(STORE_NAME, 'readwrite');
            const store = tx.objectStore(STORE_NAME);
            store.delete(id);
            return new Promise(resolve => tx.oncomplete = resolve);
        }

        function migrateFromLocalStorage() {
            const oldData = localStorage.getItem('my_magic_collection_v3');
            if(oldData) {
                try {
                    const parsed = JSON.parse(oldData);
                    if(parsed.length > 0) {
                        if(confirm('å‘ç°æ—§ç‰ˆæœ¬æ•°æ®ï¼Œæ˜¯å¦è¿ç§»åˆ°æ— é™ç©ºé—´ï¼Ÿ(è¿ç§»åæ—§æ•°æ®ä¼šä»ç¼“å­˜æ¸…ç©º)')) {
                            const tx = db.transaction(STORE_NAME, 'readwrite');
                            const store = tx.objectStore(STORE_NAME);
                            parsed.forEach(item => { delete item.id; store.add(item); });
                            tx.oncomplete = () => {
                                alert('è¿ç§»æˆåŠŸï¼äº«å—æ— é™ç©ºé—´å§ï¼âœ¨');
                                localStorage.removeItem('my_magic_collection_v3');
                                loadFromDB();
                            };
                        }
                    }
                } catch(e) {}
            }
        }

        function renderGrid(dataList) {
            const container = document.getElementById('gridContainer');
            container.innerHTML = '';
            if (dataList.length === 0) { container.innerHTML = '<div class="empty-state">ç©ºç©ºçš„...å¿«å»æ·»åŠ å§ï¼</div>'; return; }
            
            dataList.forEach((item) => {
                const realIndex = items.indexOf(item);
                const card = document.createElement('div'); card.className = 'card';
                card.onclick = () => openDetailModal(realIndex);

                const images = item.resources.filter(r => r.type === 'image');
                let coverSrc = PLACEHOLDER_IMG;
                if (images.length > 0) {
                    let idx = item.coverIndex || 0;
                    if (idx >= images.length) idx = 0;
                    coverSrc = images[idx].content;
                }

                const imgWrapper = document.createElement('div'); imgWrapper.className = 'card-img-wrapper';
                const img = document.createElement('img'); img.src = coverSrc;
                imgWrapper.appendChild(img);

                const indicators = document.createElement('div'); indicators.className = 'content-indicators';
                const typeCounts = {};
                item.resources.forEach(r => {
                    let t = r.subType; if(r.type === 'link') t = 'é“¾æ¥';
                    typeCounts[t] = (typeCounts[t] || 0) + 1;
                });
                Object.keys(typeCounts).forEach(k => {
                    if(k !== 'é»˜è®¤') {
                        const ind = document.createElement('div'); ind.className = 'indicator';
                        ind.textContent = `${k} ${typeCounts[k]}`; indicators.appendChild(ind);
                    }
                });
                imgWrapper.appendChild(indicators);

                const content = document.createElement('div'); content.className = 'card-content';
                const title = document.createElement('h3'); title.className = 'card-title'; title.textContent = item.name;
                content.appendChild(title);
                const tagsDiv = document.createElement('div'); tagsDiv.className = 'tags-container';
                (item.tags||[]).forEach(t => {
                    const span = document.createElement('span'); span.className = 'tag-pill'; span.textContent = t;
                    tagsDiv.appendChild(span);
                });
                content.appendChild(tagsDiv);
                card.appendChild(imgWrapper); card.appendChild(content); container.appendChild(card);
            });
        }

        function resetAddModal() {
            isEditing = false; editingIndex = -1;
            document.getElementById('modalTitle').textContent = 'âœ¨ æ·»åŠ æ–°æ”¶è—';
            document.getElementById('itemName').value = '';
            document.getElementById('tagInput').value = '';
            document.getElementById('linkInputArea').style.display = 'none';
            draftResources = []; currentTags = [];
            renderTagsInput(); renderResourceList(); renderSuggestTags();
        }

        function openAddModal() { resetAddModal(); document.getElementById('addModal').classList.add('active'); }

        function openEditMode() {
            if (viewingIndex === -1) return;
            isEditing = true; editingIndex = viewingIndex;
            const item = items[editingIndex];
            document.getElementById('modalTitle').textContent = 'âœï¸ ç¼–è¾‘ç›’å­å†…å®¹';
            document.getElementById('itemName').value = item.name;
            currentTags = [...(item.tags || [])];
            draftResources = JSON.parse(JSON.stringify(item.resources));
            renderTagsInput(); renderResourceList(); renderSuggestTags();
            document.getElementById('detailModal').classList.remove('active'); 
            document.getElementById('addModal').classList.add('active');       
        }

        function renderResourceList() {
            const list = document.getElementById('resourceList'); list.innerHTML = '';
            if(draftResources.length === 0) { list.innerHTML = '<div style="text-align:center; color:#ccc; font-size:12px; padding:20px;">æš‚æ— å†…å®¹</div>'; return; }
            draftResources.forEach((res, idx) => {
                const item = document.createElement('div'); item.className = 'resource-item';
                let previewHtml = '';
                if (res.type === 'image') previewHtml = `<img src="${res.content}" style="width:100%;height:100%;object-fit:cover">`;
                else if (res.type === 'json') previewHtml = 'ğŸ“„';
                else if (res.type === 'link') previewHtml = 'ğŸ”—';
                
                let selectHtml = '';
                if (res.type !== 'link') {
                    selectHtml = `<select class="resource-type-select" onchange="updateResourceType(${idx}, this.value)">`;
                    TYPES.forEach(t => { selectHtml += `<option value="${t}" ${res.subType === t ? 'selected' : ''}>${t}</option>`; });
                    selectHtml += `</select>`;
                } else { selectHtml = `<span style="font-size:11px;color:#aaa">é“¾æ¥</span>`; }

                item.innerHTML = `<div class="resource-preview">${previewHtml}</div><div class="resource-info"><div class="resource-name" title="${res.name}">${res.name}</div>${selectHtml}</div><button class="btn-remove" onclick="removeDraftResource(${idx})">Ã—</button>`;
                list.appendChild(item);
            });
        }
        function updateResourceType(idx, val) { draftResources[idx].subType = val; }
        function removeDraftResource(idx) { draftResources.splice(idx, 1); renderResourceList(); }
        async function handleImageSelect(input) {
            const files = Array.from(input.files);
            for(let f of files) { const base64 = await readFile(f); draftResources.push({ type: 'image', subType: 'é»˜è®¤', name: f.name, content: base64 }); }
            renderResourceList(); input.value = '';
        }
        async function handleJsonSelect(input) {
            const files = Array.from(input.files);
            for(let f of files) { const text = await readFileText(f); draftResources.push({ type: 'json', subType: 'é»˜è®¤', name: f.name, content: text }); }
            renderResourceList(); input.value = '';
        }
        function openLinkInput() { document.getElementById('linkInputArea').style.display = 'block'; }
        function confirmAddLink() {
            const name = document.getElementById('newLinkName').value.trim(); const url = document.getElementById('newLinkUrl').value.trim();
            if(name && url) {
                draftResources.push({ type: 'link', subType: 'link', name: name, content: url });
                renderResourceList();
                document.getElementById('newLinkName').value = ''; document.getElementById('newLinkUrl').value = ''; document.getElementById('linkInputArea').style.display = 'none';
            } else { alert('è¯·è¾“å…¥åç§°å’Œç½‘å€'); }
        }

        async function saveItem() {
            const name = document.getElementById('itemName').value.trim();
            if (!name) { alert('åå­—ä¸èƒ½ä¸ºç©º'); return; }
            if (draftResources.length === 0) { alert('ç›’å­ä¸èƒ½ä¸ºç©ºå“¦'); return; }
            
            const itemData = { 
                name: name, 
                tags: [...currentTags], 
                resources: draftResources, 
                coverIndex: 0, 
                date: new Date().toISOString() 
            };

            if (isEditing) {
                const oldItem = items[editingIndex];
                itemData.id = oldItem.id;
                itemData.coverIndex = oldItem.coverIndex;
            }

            await saveItemToDB(itemData);
            loadFromDB(); handleSearch(); closeAddModal();
        }

        function openDetailModal(index) {
            viewingIndex = index; const item = items[index];
            document.getElementById('detailName').textContent = item.name;
            const tagsBox = document.getElementById('detailTags'); tagsBox.innerHTML = '';
            (item.tags||[]).forEach(t => { const s = document.createElement('span'); s.className='tag-pill'; s.textContent=t; tagsBox.appendChild(s); });

            const images = item.resources.filter(r => r.type === 'image');
            if(images.length === 0) { document.getElementById('galleryArea').style.display = 'none'; document.getElementById('noImgMsg').style.display = 'block'; }
            else {
                document.getElementById('galleryArea').style.display = 'block'; document.getElementById('noImgMsg').style.display = 'none';
                galleryIndex = item.coverIndex || 0;
                if(galleryIndex >= images.length) galleryIndex = 0;
                updateGalleryUI(images);
            }

            const listContainer = document.getElementById('detailListContainer'); listContainer.innerHTML = '';
            item.resources.forEach((res, i) => {
                const row = document.createElement('div'); row.className = 'detail-item';
                let icon = 'ğŸ“„', actionBtn = '', typeLabel = res.subType;
                
                if (res.type === 'image') { icon = 'ğŸ–¼ï¸'; actionBtn = `<span class="action-link" onclick="downloadResource(${i})">ä¸‹è½½</span>`; } 
                else if (res.type === 'json') { icon = 'ğŸ“„'; actionBtn = `<span class="action-link" onclick="downloadResource(${i})">ä¸‹è½½</span>`; }
                else if (res.type === 'link') { icon = 'ğŸ”—'; typeLabel = 'é“¾æ¥'; actionBtn = `<a class="action-link" href="${res.content}" target="_blank">æ‰“å¼€</a>`; }
                
                row.innerHTML = `<div style="display:flex;align-items:center;min-width:0;"><span class="detail-item-type">${typeLabel}</span><span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${icon} ${res.name}</span></div><div style="flex-shrink:0;margin-left:10px;">${actionBtn}</div>`;
                listContainer.appendChild(row);
            });
            document.getElementById('detailModal').classList.add('active');
        }

        function updateGalleryUI(images) {
            const imgEl = document.getElementById('detailImg'); const typeLabel = document.getElementById('galleryTypeLabel');
            const curImg = images[galleryIndex]; imgEl.src = curImg.content; typeLabel.textContent = curImg.subType;
            document.getElementById('imgIndex').textContent = galleryIndex + 1; document.getElementById('imgTotal').textContent = images.length;
            const coverBtn = document.getElementById('setCoverBtn');
            if(galleryIndex === (items[viewingIndex].coverIndex || 0)) { coverBtn.textContent = 'å½“å‰å°é¢'; coverBtn.classList.add('is-cover'); }
            else { coverBtn.textContent = 'è®¾ä¸ºå°é¢'; coverBtn.classList.remove('is-cover'); }
        }
        function changeGalleryImage(d) {
            const images = items[viewingIndex].resources.filter(r => r.type === 'image'); if(images.length === 0) return;
            galleryIndex += d; if(galleryIndex >= images.length) galleryIndex = 0; if(galleryIndex < 0) galleryIndex = images.length - 1;
            updateGalleryUI(images);
        }
        async function setAsCover() {
            if(viewingIndex === -1) return; 
            const item = items[viewingIndex];
            item.coverIndex = galleryIndex;
            await saveItemToDB(item); 
            const images = item.resources.filter(r => r.type === 'image'); 
            updateGalleryUI(images); loadFromDB(); 
        }
        function downloadCurrentGalleryImg() {
            const images = items[viewingIndex].resources.filter(r => r.type === 'image'); if(images.length === 0) return;
            const cur = images[galleryIndex]; downloadFile(cur.name, cur.content);
        }
        function downloadResource(resIndex) {
            const res = items[viewingIndex].resources[resIndex]; if(res.type === 'link') return; downloadFile(res.name, res.content);
        }

        function downloadFile(name, content) {
            const a = document.createElement('a');
            if (content.startsWith('data:')) {
                a.href = content;
            } else {
                const blob = new Blob([content], {type: 'application/json'});
                a.href = URL.createObjectURL(blob);
            }
            a.download = name;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            if (!content.startsWith('data:')) URL.revokeObjectURL(a.href);
        }

        function readFile(file) { return new Promise(resolve => { const r = new FileReader(); r.onload = e => resolve(e.target.result); r.readAsDataURL(file); }); }
        function readFileText(file) { return new Promise(resolve => { const r = new FileReader(); r.onload = e => resolve(e.target.result); r.readAsText(file); }); }
        
        function handleTagInput(e) { if(e.key==='Enter'){ e.preventDefault(); const v=e.target.value.trim(); if(v && !currentTags.includes(v)) { currentTags.push(v); e.target.value=''; renderTagsInput(); } } if(e.key==='Backspace' && !e.target.value) { currentTags.pop(); renderTagsInput(); } }
        function renderTagsInput() { const area=document.getElementById('tagInputArea'); const inp=document.getElementById('tagInput'); Array.from(area.children).forEach(c=>c!==inp && area.removeChild(c)); currentTags.forEach((t,i)=>{ const d=document.createElement('div'); d.className='tag-chip'; d.innerHTML=`${t} <span onclick="currentTags.splice(${i},1);renderTagsInput()" style="cursor:pointer">Ã—</span>`; area.insertBefore(d,inp); }); }
        function renderSuggestTags() { const all=new Set(); items.forEach(i=>(i.tags||[]).forEach(t=>all.add(t))); const box=document.getElementById('suggestedTags'); box.innerHTML=''; all.forEach(t=>{ const d=document.createElement('div'); d.className='tag-chip'; d.style.background='#f0f0f0'; d.style.color='#666'; d.style.cursor='pointer'; d.textContent=t; d.onclick=()=>{if(!currentTags.includes(t)){currentTags.push(t);renderTagsInput();}}; box.appendChild(d); }); }
        function handleSearch(){ const q=document.getElementById('searchInput').value.toLowerCase(); const f=items.filter(i=>i.name.toLowerCase().includes(q)||(i.tags||[]).some(t=>t.toLowerCase().includes(q))); renderGrid(f); }
        function closeAddModal() { document.getElementById('addModal').classList.remove('active'); }
        function closeDetailModal() { document.getElementById('detailModal').classList.remove('active'); viewingIndex=-1; }
        
        async function deleteCurrentItem() { 
            if(confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ')) { 
                const id = items[viewingIndex].id;
                await deleteItemFromDB(id);
                loadFromDB(); closeDetailModal(); 
            } 
        }

        function exportAllData() { 
            const tx = db.transaction(STORE_NAME, 'readonly');
            const store = tx.objectStore(STORE_NAME);
            const req = store.getAll();
            req.onsuccess = () => {
                const blob = new Blob([JSON.stringify(req.result)], {type:'application/json'}); 
                const a = document.createElement('a'); 
                a.href = URL.createObjectURL(blob); 
                a.download = `å¤‡ä»½_${new Date().toISOString().slice(0,10)}.json`; 
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            }
        }
        
        function importAllData(el) { 
            const file = el.files[0]; if(!file) return; 
            const r = new FileReader(); 
            r.onload = e => { 
                try { 
                    const imported = JSON.parse(e.target.result); 
                    if(Array.isArray(imported)) {
                        const tx = db.transaction(STORE_NAME, 'readwrite');
                        const store = tx.objectStore(STORE_NAME);
                        imported.forEach(item => { delete item.id; store.add(item); }); 
                        tx.oncomplete = () => { loadFromDB(); alert('å¯¼å…¥æˆåŠŸï¼'); };
                    }
                } catch{ alert('æ–‡ä»¶æ ¼å¼é”™è¯¯'); } 
            }; 
            r.readAsText(file); 
        }
        
        function initMusic() { const link = localStorage.getItem('my_bgm_link') || DEFAULT_MUSIC; const audio = document.getElementById('bgMusic'); audio.src = link; audio.volume = 0.5; document.getElementById('musicLink').value = link; }
        function toggleMusic() { const a=document.getElementById('bgMusic'); const b=document.getElementById('playBtn'); if(a.paused){a.play();b.textContent='â¸';}else{a.pause();b.textContent='â–¶';} }
        function changeVolume(s) { document.getElementById('bgMusic').volume=s.value; }
        function updateMusicSrc(v) { if(v){document.getElementById('bgMusic').src=v; localStorage.setItem('my_bgm_link',v); document.getElementById('playBtn').textContent='â–¶';} }
        function renderNavPanel() { const c = document.getElementById('navPanel'); const t = c.querySelector('.nav-title'); c.innerHTML=''; c.appendChild(t); const map={}; const no=[]; items.forEach((it,i)=>{ if(!it.tags||it.tags.length==0)no.push(i); else it.tags.forEach(tag=>{ if(!map[tag])map[tag]=[]; map[tag].push(i); }); }); if(no.length) createNavGroup(c,'ğŸ“‚ æœªåˆ†ç±»',no); Object.keys(map).sort().forEach(k=>createNavGroup(c,`ğŸ·ï¸ ${k}`,map[k])); }
        function createNavGroup(c,t,idx) { const g=document.createElement('div'); g.style.marginBottom='5px'; const h=document.createElement('div'); h.innerHTML=`${t} â–¾`; h.style.cssText='padding:5px;font-size:12px;font-weight:bold;cursor:pointer;color:#555;'; h.onclick=()=>{l.style.display=l.style.display==='none'?'block':'none'}; const l=document.createElement('div'); l.style.cssText='display:none;padding-left:10px;'; idx.forEach(i=>{ const it=document.createElement('div'); it.textContent=items[i].name; it.style.cssText='font-size:11px;padding:3px;cursor:pointer;color:#888;'; it.onclick=()=>{openDetailModal(i);document.getElementById('floatMenu').classList.remove('active')}; l.appendChild(it); }); g.appendChild(h); g.appendChild(l); c.appendChild(g); }

        function initDraggable() {
            const w=document.getElementById('floatWidget'), b=document.getElementById('floatBtn'), m=document.getElementById('floatMenu');
            let isDragging=false, startX, startY, initialLeft, initialTop;
            b.addEventListener('mousedown', s); b.addEventListener('touchstart', s, {passive:false});
            function s(e) { 
                if(e.target.closest('.float-menu'))return; isDragging=false; 
                const c=e.type.includes('mouse')?e:e.touches[0]; startX=c.clientX; startY=c.clientY; 
                const r=w.getBoundingClientRect(); initialLeft=r.left; initialTop=r.top;
                w.style.left=initialLeft+'px'; w.style.top=initialTop+'px'; w.style.bottom='auto'; w.style.right='auto';
                if(e.type.includes('mouse')) { document.addEventListener('mousemove', mv); document.addEventListener('mouseup', ed); } else { document.addEventListener('touchmove', mv, {passive:false}); document.addEventListener('touchend', ed); }
            }
            function mv(e) { 
                const c=e.type.includes('mouse')?e:e.touches[0]; const dx=c.clientX-startX, dy=c.clientY-startY; 
                if(Math.abs(dx)>5||Math.abs(dy)>5){ isDragging=true; if(m.classList.contains('active'))m.classList.remove('active'); }
                if(isDragging){ e.preventDefault(); w.style.left=(initialLeft+dx)+'px'; w.style.top=(initialTop+dy)+'px'; }
            }
            function ed() { document.removeEventListener('mousemove',mv); document.removeEventListener('mouseup',ed); document.removeEventListener('touchmove',mv); document.removeEventListener('touchend',ed); }
            b.addEventListener('click', (e)=>{ if(isDragging){e.preventDefault();e.stopPropagation();}else{m.classList.toggle('active');} });
            document.addEventListener('click', (e)=>{ if(m.classList.contains('active')&&!w.contains(e.target)){m.classList.remove('active');} });
        }
    </script>
</body>
</html>
