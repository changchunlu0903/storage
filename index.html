<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>âœ¨ æˆ‘çš„ç™¾å®ç®± v8.1 (ä¿®å¤ç‰ˆ) âœ¨</title>
    <style>
        /* --- å¼•å…¥å®šåˆ¶å­—ä½“ --- */
        @font-face { font-family: 'MyCustomFont'; src: url('https://files.catbox.moe/cweam3.ttf') format('truetype'); font-display: swap; }

        :root {
            --primary-color: #ffb7c5; --secondary-color: #ffe6eb; --accent-color: #ff8fa3;
            --text-color: #6d5c5c; --radius: 20px; --shadow: 0 8px 24px rgba(255, 183, 197, 0.4);
        }

        body {
            font-family: 'MyCustomFont', 'Microsoft YaHei', sans-serif;
            background-color: var(--secondary-color); color: var(--text-color);
            margin: 0; padding: 20px;
            background-image: radial-gradient(#fff 2px, transparent 2px); background-size: 30px 30px;
            overflow-x: hidden; padding-bottom: 100px;
            /* é”å±æ—¶ç¦æ­¢æ»šåŠ¨ */
            height: 100vh; overflow: hidden; 
        }
        body.unlocked { height: auto; overflow: auto; }

        h1 { text-align: center; color: var(--accent-color); font-weight: normal; margin: 10px 0 30px 0; text-shadow: 2px 2px 0px #fff; font-size: 32px; }

        /* --- ğŸŒ¸ æ¨±èŠ±é”å±å°é¢ --- */
        #authOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #fff0f5 0%, #ffe6eb 100%);
            z-index: 10000; display: flex; justify-content: center; align-items: center; flex-direction: column;
            overflow: hidden;
        }
        /* èƒŒæ™¯å±‚çº§è®¾ä½ï¼Œé˜²æ­¢æŒ¡ä½ç‚¹å‡» */
        .sakura-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
        .sakura {
            position: absolute; background-color: #ffb7c5; border-radius: 100% 0 100% 0;
            animation: fall linear infinite; opacity: 0.7;
        }
        @keyframes fall {
            0% { top: -10%; transform: rotate(0deg) translateX(0); }
            100% { top: 110%; transform: rotate(360deg) translateX(100px); }
        }

        /* è®¤è¯æ¡†å±‚çº§æé«˜ï¼Œç¡®ä¿èƒ½ç‚¹åˆ° */
        .auth-box {
            background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 30px;
            box-shadow: 0 15px 35px rgba(255, 183, 197, 0.3); text-align: center;
            width: 85%; max-width: 380px; border: 3px solid #fff; position: relative;
            backdrop-filter: blur(5px); z-index: 10001; /* å…³é”®ï¼šå±‚çº§æœ€é«˜ */
        }
        .auth-title { color: var(--accent-color); font-size: 24px; margin-bottom: 20px; font-weight: bold;}
        .auth-subtitle { color: #999; font-size: 14px; margin-bottom: 20px; }

        #gestureCanvas { margin: 0 auto; display: block; cursor: crosshair; touch-action: none; background: #fff5f7; border-radius: 15px; }

        .pin-container { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; }
        .pin-input {
            width: 50px; height: 50px; border: 2px solid var(--primary-color); border-radius: 15px;
            text-align: center; font-size: 24px; color: var(--accent-color); outline: none;
            background: #fff; -webkit-text-security: disc;
        }
        .pin-input:focus { border-color: var(--accent-color); transform: scale(1.05); }

        .auth-btn {
            background: linear-gradient(to right, var(--primary-color), var(--accent-color));
            color: white; border: none; padding: 12px 20px; border-radius: 25px;
            font-size: 16px; cursor: pointer; font-family: inherit; box-shadow: 0 5px 15px rgba(255, 130, 150, 0.3);
            transition: transform 0.1s; width: 100%; margin-top: 10px;
            -webkit-tap-highlight-color: transparent; /* ç§»é™¤æ‰‹æœºç‚¹å‡»é«˜äº®å— */
        }
        .auth-btn:active { transform: scale(0.98); }
        
        .switch-link, .forgot-link { display: block; margin-top: 15px; color: var(--accent-color); text-decoration: underline; cursor: pointer; font-size: 14px; padding: 5px; }
        .forgot-link { color: #aaa; font-size: 13px; }

        .security-form { text-align: left; margin-top: 20px; }
        .security-form label { color: var(--text-color); font-size: 14px; margin-bottom: 5px; display: block; }
        .security-form input { width: 100%; padding: 10px; border: 2px solid var(--secondary-color); border-radius: 12px; margin-bottom: 15px; outline: none; box-sizing: border-box; font-family: inherit;}

        /* å†…å®¹éšè— */
        #mainContent { display: none; filter: blur(10px); transition: filter 0.5s; }
        body.unlocked #mainContent { display: block; filter: blur(0); }

        /* --- æ‚¬æµ®çª— & UI (ä¿æŒæ ·å¼) --- */
        .float-widget { position: fixed; bottom: 30px; right: 30px; z-index: 9999; touch-action: none; }
        .float-btn { width: 48px; height: 48px; border-radius: 50%; background: #fff; border: 3px solid var(--primary-color); box-shadow: 0 5px 15px rgba(255, 117, 143, 0.3); display: flex; justify-content: center; align-items: center; font-size: 24px; cursor: move; user-select: none; transition: transform 0.1s; position: relative; }
        .float-btn:active { transform: scale(0.9); } .float-btn::after { content: 'ğŸ¶'; }
        .float-menu { position: absolute; bottom: 60px; right: 0; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; width: 260px; padding: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); border: 2px solid #fff; transform-origin: bottom right; transform: scale(0); opacity: 0; transition: all 0.2s; pointer-events: none; max-height: 60vh; display: flex; flex-direction: column; }
        .float-menu.active { transform: scale(1); opacity: 1; pointer-events: auto; }
        .music-panel { background: var(--secondary-color); border-radius: 15px; padding: 12px; margin-bottom: 15px; text-align: center; }
        .music-controls { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 8px; }
        .play-btn { background: var(--accent-color); color: white; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .nav-panel { flex-grow: 1; overflow-y: auto; } .nav-title { font-weight: bold; color: var(--accent-color); margin-bottom: 8px; border-bottom: 1px dashed #ddd; }
        .search-container { max-width: 600px; margin: 0 auto 30px auto; position: relative; }
        .search-input { width: 100%; padding: 15px 50px 15px 25px; border: 2px solid #fff; border-radius: 50px; background: rgba(255, 255, 255, 0.9); font-size: 16px; outline: none; font-family: inherit; }
        .search-input:focus { border-color: var(--primary-color); } .search-icon { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); color: var(--primary-color); }
        .controls { display: flex; justify-content: center; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; }
        button { background: #fff; border: 2px solid var(--primary-color); color: var(--accent-color); padding: 8px 18px; border-radius: 50px; cursor: pointer; font-family: inherit; font-size: 14px; transition: all 0.2s; display: flex; align-items: center; gap: 5px; }
        button:hover { background: var(--primary-color); color: white; transform: translateY(-2px); } button.primary-btn { background: var(--accent-color); color: white; border: none; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; max-width: 1200px; margin: 0 auto; }
        .card { background: #fff; border-radius: var(--radius); overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.05); transition: transform 0.3s; border: 3px solid #fff; display: flex; flex-direction: column; cursor: pointer; position: relative; }
        .card:hover { transform: translateY(-5px); border-color: var(--primary-color); }
        .card-img-wrapper { height: 200px; background-color: #fcecef; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; } .card img { width: 100%; height: 100%; object-fit: cover; }
        .content-indicators { position: absolute; top: 8px; left: 8px; display: flex; gap: 4px; flex-wrap: wrap; } .indicator { background: rgba(255,255,255,0.95); padding: 2px 6px; border-radius: 6px; font-size: 12px; color: var(--text-color); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card-content { padding: 10px; flex-grow: 1; display: flex; flex-direction: column; } .card-title { font-size: 18px; margin: 0 0 5px 0; color: var(--text-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .tags-container { display: flex; flex-wrap: wrap; gap: 4px; margin-top: auto; } .tag-pill { background: var(--secondary-color); color: var(--accent-color); font-size: 12px; padding: 2px 6px; border-radius: 8px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 240, 245, 0.85); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 2000; } .modal-overlay.active { display: flex; }
        .modal { background: white; padding: 25px; border-radius: 25px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 15px 40px rgba(255, 130, 150, 0.2); position: relative; }
        .form-group { margin-bottom: 15px; } .form-group label { display: block; margin-bottom: 5px; font-size: 16px; color: var(--accent-color); }
        input[type="text"], select { width: 100%; padding: 10px; border: 2px solid var(--secondary-color); border-radius: 12px; outline: none; box-sizing: border-box; background: #fff; font-family: inherit; font-size: 15px; }
        .tag-input-area { border: 2px solid var(--secondary-color); border-radius: 12px; padding: 8px; display: flex; flex-wrap: wrap; gap: 5px; min-height: 40px; } .tag-input-area input { border: none; outline: none; flex-grow: 1; padding: 5px; font-family: inherit; }
        .tag-chip { background: var(--primary-color); color: white; padding: 3px 8px; border-radius: 10px; font-size: 14px; display: flex; gap: 5px; align-items: center; }
        .resource-list { border: 1px solid #eee; border-radius: 12px; padding: 10px; max-height: 200px; overflow-y: auto; background: #fafafa; }
        .resource-item { display: flex; align-items: center; gap: 10px; background: white; padding: 8px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #f0f0f0; }
        .resource-preview { width: 40px; height: 40px; border-radius: 5px; object-fit: cover; background: #eee; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 20px;}
        .resource-info { flex-grow: 1; min-width: 0; } .resource-name { font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .resource-type-select { font-size: 12px; padding: 2px; border: 1px solid #ddd; border-radius: 4px; margin-top: 2px; font-family: inherit; }
        .btn-remove { background: #ffdede; color: #ff6b6b; border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; font-weight: bold; }
        .add-btn-row { display: flex; gap: 10px; margin-top: 5px; } .small-btn { font-size: 14px; padding: 5px 12px; }
        .gallery-container { position: relative; width: 100%; height: 320px; background: #fafafa; border-radius: 15px; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; border: 1px solid #eee; flex-direction: column;}
        .gallery-img { max-width: 100%; max-height: 100%; object-fit: contain; } .gallery-type-label { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.6); color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; z-index: 10; }
        .gallery-nav { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.8); border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); user-select: none; z-index: 10; } .nav-prev { left: 10px; } .nav-next { right: 10px; }
        .cover-btn { position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.9); border: 2px solid var(--accent-color); color: var(--accent-color); font-size: 12px; padding: 4px 10px; cursor: pointer; border-radius: 20px; z-index: 10; font-family: inherit; } .cover-btn.is-cover { background: var(--accent-color); color: white; }
        .download-img-btn { position: absolute; bottom: 10px; right: 10px; background: rgba(255,255,255,0.9); border: 2px solid var(--primary-color); color: var(--primary-color); width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 10; transition: all 0.2s;}
        .detail-list { margin-top: 10px; } .detail-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px dashed #eee; font-size: 14px; }
        .detail-item-type { background: #f0f0f0; padding: 2px 6px; border-radius: 4px; color: #888; margin-right: 5px; font-size: 12px; }
        .action-link { color: var(--accent-color); text-decoration: none; cursor: pointer; font-weight: bold; font-size: 12px; background: #fff0f3; padding: 4px 8px; border-radius: 4px; transition: background 0.2s; } .action-link:hover { background: var(--primary-color); color: white; }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; } .close-modal { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 28px; cursor: pointer; color: #ccc; }
        .empty-state { grid-column: 1 / -1; text-align: center; color: #cea0a9; padding: 50px; font-size: 18px; } .edit-btn { background: #fff8e1; border-color: #ffc107; color: #ffb300; }
        input[type="file"] { display: none; }
    </style>
</head>
<body>

    <div id="authOverlay">
        <div class="sakura-bg" id="sakuraBg"></div>
        
        <div class="auth-box" id="setupBox" style="display:none;">
            <div class="auth-title">ğŸŒ¸ æ¬¢è¿æ¥åˆ°ä½ çš„ç™¾å®ç®±</div>
            <div class="auth-subtitle">ç¬¬ä¸€æ¬¡æ¥ï¼Œå…ˆç»™è‡ªå·±æŒ‘ä¸€æŠŠé’¥åŒ™å§ï¼</div>
            <button class="auth-btn" onclick="showSetup('gesture')">æˆ‘æ˜¯æ‰‹åŠ¿æ§ (è¿çº¿è§£é”)</button>
            <button class="auth-btn" onclick="showSetup('pin')" style="background: linear-gradient(to right, #a8edea, #fed6e3);">æˆ‘æ˜¯æ•°å­—æ§ (PINç è§£é”)</button>
        </div>

        <div class="auth-box" id="gestureBox" style="display:none;">
            <div class="auth-title" id="gestureTitle">ç»˜åˆ¶è§£é”å›¾æ¡ˆ</div>
            <div class="auth-subtitle" id="gestureSubtitle">è¯·è¿æ¥è‡³å°‘4ä¸ªç‚¹</div>
            <canvas id="gestureCanvas" width="300" height="300"></canvas>
            <span class="switch-link" onclick="backToChoice()" id="gestureBackBtn">è¿”å›é€‰æ‹©</span>
            <span class="forgot-link" onclick="showReset()" id="gestureForgotBtn" style="display:none">å¿˜è®°å¯†ç ?</span>
        </div>

        <div class="auth-box" id="pinBox" style="display:none;">
            <div class="auth-title" id="pinTitle">è¾“å…¥4ä½æ•°å­—å¯†ç </div>
            <div class="auth-subtitle" id="pinSubtitle">è¯·ç‰¢è®°ä½ çš„ç”Ÿæ—¥æˆ–å¹¸è¿æ•°å­—å“¦</div>
            <div class="pin-container">
                <input type="number" class="pin-input" maxlength="1" oninput="focusNext(this, 0)">
                <input type="number" class="pin-input" maxlength="1" oninput="focusNext(this, 1)">
                <input type="number" class="pin-input" maxlength="1" oninput="focusNext(this, 2)">
                <input type="number" class="pin-input" maxlength="1" oninput="focusNext(this, 3)">
            </div>
            <span class="switch-link" onclick="backToChoice()" id="pinBackBtn">è¿”å›é€‰æ‹©</span>
             <span class="forgot-link" onclick="showReset()" id="pinForgotBtn" style="display:none">å¿˜è®°å¯†ç ?</span>
        </div>

        <div class="auth-box" id="securityBox" style="display:none;">
            <div class="auth-title" id="securityTitle">è®¾ç½®å®‰å…¨é—®é¢˜</div>
            <div class="auth-subtitle" id="securitySubtitle">è¿™æ˜¯æ‰¾å›å¯†ç çš„å”¯ä¸€å‡­è¯å“¦ï¼</div>
            <div class="security-form">
                <label>é—®é¢˜ (ä¾‹å¦‚: æˆ‘çš„åˆæ‹æ˜¯è°?)</label>
                <input type="text" id="secQuestion">
                <label>ç­”æ¡ˆ</label>
                <input type="text" id="secAnswer">
            </div>
            <button class="auth-btn" onclick="finishSetup()" id="securitySaveBtn">ä¿å­˜å¹¶è¿›å…¥</button>
            <button class="auth-btn" onclick="verifyReset()" id="securityVerifyBtn" style="display:none">éªŒè¯å¹¶é‡ç½®</button>
             <span class="switch-link" onclick="cancelReset()" id="securityCancelBtn" style="display:none">å–æ¶ˆ</span>
        </div>
    </div>


    <div id="mainContent">
        <h1>ğŸŒ¸ æˆ‘çš„ç™¾å®ç®± v8.1 ğŸŒ¸</h1>
        <div class="float-widget" id="floatWidget">
            <div class="float-menu" id="floatMenu">
                <div class="music-panel">
                    <div style="font-size:12px; color:#aaa; margin-bottom:5px;">ğŸ§ èƒŒæ™¯éŸ³ä¹</div>
                    <div class="music-controls">
                        <button class="play-btn" onclick="toggleMusic()" id="playBtn">â–¶</button>
                        <input type="range" min="0" max="1" step="0.1" value="0.5" onchange="changeVolume(this)" style="width:60px; accent-color:var(--accent-color)">
                    </div>
                    <input type="text" style="width:100%;font-size:10px;padding:4px;border:1px solid #ddd;border-radius:5px;" id="musicLink" placeholder="è¾“å…¥mp3é“¾æ¥..." onchange="updateMusicSrc(this.value)">
                    <audio id="bgMusic" loop></audio>
                </div>
                <div class="nav-panel" id="navPanel">
                    <div class="nav-title">ğŸ·ï¸ å¿«é€Ÿè·³è½¬</div>
                </div>
            </div>
            <div class="float-btn" id="floatBtn"></div>
        </div>
        <div class="search-container"><input type="text" class="search-input" id="searchInput" placeholder="æœç´¢åç§°æˆ–æ ‡ç­¾..." oninput="handleSearch()"><span class="search-icon">ğŸ”</span></div>
        <div class="controls"><button onclick="openAddModal()" class="primary-btn"><span>â•</span> æ·»åŠ ç´ æ</button><button onclick="exportAllData()"><span>ğŸ’¾</span> å¤‡ä»½å…¨éƒ¨</button><button onclick="document.getElementById('importAllInput').click()"><span>ğŸ“‚</span> å¯¼å…¥å¤‡ä»½</button><input type="file" id="importAllInput" accept=".json" onchange="importAllData(this)"></div>
        <div class="grid-container" id="gridContainer"><div class="empty-state">æ­£åœ¨åˆå§‹åŒ–æ•°æ®åº“... ğŸ’¾</div></div>
    </div>

    <div class="modal-overlay" id="addModal">
        <div class="modal">
            <button class="close-modal" onclick="closeAddModal()">Ã—</button>
            <h2 id="modalTitle">âœ¨ æ·»åŠ æ–°æ”¶è—</h2>
            <div class="form-group"><label>ğŸ’– åå­—</label><input type="text" id="itemName" placeholder="ç»™è¿™ä¸ªç›’å­èµ·ä¸ªåå­—..."></div>
            <div class="form-group"><label>ğŸ·ï¸ æ ‡ç­¾ (å›è½¦æ·»åŠ )</label><div class="tag-input-area" id="tagInputArea" onclick="document.getElementById('tagInput').focus()"><input type="text" id="tagInput" onkeydown="handleTagInput(event)"></div><div id="suggestedTags" style="margin-top:5px; display:flex; gap:5px; flex-wrap:wrap;"></div></div>
            <div class="form-group"><label>ğŸ“¦ åŒ…å«çš„æ–‡ä»¶ä¸é“¾æ¥</label><div class="resource-list" id="resourceList"><div style="text-align:center; color:#ccc; font-size:12px; padding:20px;">æš‚æ— å†…å®¹ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ </div></div><div class="add-btn-row"><label class="upload-area small-btn">ğŸ–¼ï¸ åŠ å›¾ç‰‡<input type="file" accept="image/*" multiple onchange="handleImageSelect(this)"></label><label class="upload-area small-btn">ğŸ“„ åŠ JSON<input type="file" accept=".json,application/json" multiple onchange="handleJsonSelect(this)"></label><button class="small-btn" onclick="openLinkInput()">ğŸ”— åŠ é“¾æ¥</button></div><div id="linkInputArea" style="display:none; margin-top:10px; background:#f9f9f9; padding:10px; border-radius:10px;"><input type="text" id="newLinkName" placeholder="é“¾æ¥åç§° (å¦‚: ä½œè€…ä¸»é¡µ)" style="margin-bottom:5px;"><input type="text" id="newLinkUrl" placeholder="ç½‘å€ (http://...)" style="margin-bottom:5px;"><div style="text-align:right;"><button class="small-btn" onclick="confirmAddLink()">ç¡®å®š</button><button class="small-btn" style="background:#eee; color:#666; border:none" onclick="document.getElementById('linkInputArea').style.display='none'">å–æ¶ˆ</button></div></div></div>
            <div class="modal-buttons"><button onclick="closeAddModal()">å–æ¶ˆ</button><button class="primary-btn" onclick="saveItem()">ğŸ’¾ ä¿å­˜</button></div>
        </div>
    </div>
    <div class="modal-overlay" id="detailModal">
        <div class="modal">
            <button class="close-modal" onclick="closeDetailModal()">Ã—</button>
            <h2 id="detailName" style="text-align:center; margin-bottom:5px;"></h2>
            <div id="detailTags" style="display:flex; justify-content:center; gap:5px; margin-bottom:15px;"></div>
            <div id="galleryArea"><div class="gallery-container"><div class="gallery-type-label" id="galleryTypeLabel">ç±»å‹</div><img id="detailImg" class="gallery-img" src=""><div class="gallery-nav nav-prev" onclick="changeGalleryImage(-1)">â®</div><div class="gallery-nav nav-next" onclick="changeGalleryImage(1)">â¯</div><button id="setCoverBtn" class="cover-btn" onclick="setAsCover()">è®¾ä¸ºå°é¢</button><button class="download-img-btn" onclick="downloadCurrentGalleryImg()" title="ä¸‹è½½æ­¤å›¾">â¬‡ï¸</button><div style="position:absolute; bottom:10px; left:10px; background:rgba(0,0,0,0.5); color:white; padding:2px 8px; border-radius:10px; font-size:12px; pointer-events:none;"><span id="imgIndex">1</span> / <span id="imgTotal">1</span></div></div></div><div id="noImgMsg" style="text-align:center; color:#ccc; padding:20px; display:none;">(æ­¤ç›’å­æ²¡æœ‰å›¾ç‰‡)</div>
            <div class="form-group"><label>ğŸ“‚ ç›’å­å†…å®¹</label><div id="detailListContainer" class="detail-list"></div></div>
            <div class="modal-buttons" style="justify-content: center; flex-wrap:wrap;"><button class="edit-btn" onclick="openEditMode()">âœï¸ ç¼–è¾‘ç›’å­å†…å®¹</button><button onclick="deleteCurrentItem()" style="border-color: #ffcccc; color: #ff6b6b;">ğŸ—‘ï¸ åˆ é™¤ç›’å­</button></div>
        </div>
    </div>

    <script>
        // --- é”™è¯¯æ•è· (é˜²å¡æ­») ---
        window.onerror = function(msg, url, line) {
            alert('é‡åˆ°äº†ä¸€ç‚¹å°é”™è¯¯: ' + msg + '\nå»ºè®®ä¸è¦åœ¨"runoob"ç­‰åœ¨çº¿å·¥å…·è¿è¡Œï¼Œè¯·ä½¿ç”¨GitHub Pagesé“¾æ¥ã€‚');
            // å°è¯•å¼ºåˆ¶è§£é”ï¼Œé˜²æ­¢ç”¨æˆ·è¢«å¡åœ¨å°é¢
            document.getElementById('authOverlay').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            document.getElementById('mainContent').style.filter = 'none';
        };

        // --- å…¨å±€å˜é‡ ---
        let items = [], draftResources = [], currentTags = [];
        let isEditing = false, editingIndex = -1, viewingIndex = -1, galleryIndex = 0;
        const TYPES = ['é»˜è®¤', 'äººç‰©å¡', 'ä¸–ç•Œä¹¦', 'QRç ', 'é¢„è®¾', 'é¢„è®¾æ­£åˆ™', 'æ’ä»¶'];
        const PLACEHOLDER_IMG = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23ffe6eb'/%3E%3Ctext x='50' y='50' fill='%23ffb7c5' text-anchor='middle' dy='.3em'%3Eæ— å›¾%3C/text%3E%3C/svg%3E";
        const DEFAULT_MUSIC = "https://files.catbox.moe/btptsb.mp3";
        const DB_NAME = 'MyMagicDB_v2', STORE_NAME = 'items', AUTH_STORE_NAME = 'auth';
        let db;

        // --- åˆå§‹åŒ– ---
        window.onload = function() {
            createSakura();
            // å¼‚æ­¥å¯åŠ¨æ•°æ®åº“ï¼ŒåŠ  try-catch é˜²æ­¢ä¸æ”¯æŒçš„ç¯å¢ƒå¡æ­»
            try {
                initDB().then(() => { checkAuthStatus(); }).catch(err => {
                    console.error(err);
                    alert("æ•°æ®åº“å¯åŠ¨å¤±è´¥ï¼ˆå¯èƒ½åœ¨éšèº«æ¨¡å¼æˆ–åœ¨çº¿ç¼–è¾‘å™¨ä¸­ï¼‰ã€‚\nå·²è¿›å…¥ã€ä¸´æ—¶æ¨¡å¼ã€‘ï¼Œåˆ·æ–°åæ•°æ®ä¼šä¸¢å¤±å“¦ï¼");
                    document.getElementById('authOverlay').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                    document.getElementById('mainContent').style.filter = 'none';
                });
            } catch(e) {
                console.error(e);
            }
            initMusic(); initDraggable(); initGestureCanvas();
        };

        // --- ğŸŒ¸ æ¨±èŠ±ç‰¹æ•ˆ ---
        function createSakura() {
            const bg = document.getElementById('sakuraBg');
            for(let i=0; i<15; i++) {
                let petal = document.createElement('div'); petal.className = 'sakura';
                petal.style.left = Math.random() * 100 + '%';
                petal.style.animationDuration = (Math.random() * 5 + 5) + 's';
                petal.style.animationDelay = Math.random() * 5 + 's';
                petal.style.width = petal.style.height = (Math.random() * 10 + 10) + 'px';
                bg.appendChild(petal);
            }
        }

        // --- DB & Auth ---
        function initDB() {
            return new Promise((resolve, reject) => {
                if(!window.indexedDB) { reject('æµè§ˆå™¨ä¸æ”¯æŒIndexedDB'); return; }
                const request = indexedDB.open(DB_NAME, 2);
                request.onerror = (e) => reject('æ‰“å¼€æ•°æ®åº“å¤±è´¥');
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                    if (!db.objectStoreNames.contains(AUTH_STORE_NAME)) db.createObjectStore(AUTH_STORE_NAME, { keyPath: 'id' });
                };
                request.onsuccess = (e) => { db = e.target.result; resolve(); };
            });
        }

        async function checkAuthStatus() {
            const tx = db.transaction(AUTH_STORE_NAME, 'readonly');
            const store = tx.objectStore(AUTH_STORE_NAME);
            const req = store.get('config');
            req.onsuccess = () => {
                if (req.result) { authMode = 'login'; tempAuthData = req.result; showLogin(req.result.type); } 
                else { authMode = 'setup'; document.getElementById('setupBox').style.display = 'block'; }
            };
            req.onerror = () => { document.getElementById('setupBox').style.display = 'block'; } // å‡ºé”™åˆ™é»˜è®¤æ˜¾ç¤ºè®¾ç½®
        }

        // ç•Œé¢åˆ‡æ¢å‡½æ•°
        let authMode = 'setup', tempAuthData = {};
        function hideAllAuthBoxes() {
            ['setupBox','gestureBox','pinBox','securityBox'].forEach(id => document.getElementById(id).style.display = 'none');
        }
        function showSetup(type) {
            hideAllAuthBoxes(); tempAuthData.type = type;
            if(type==='gesture'){ document.getElementById('gestureBox').style.display='block'; document.getElementById('gestureBackBtn').style.display='block'; resetGesture(); }
            else { document.getElementById('pinBox').style.display='block'; document.getElementById('pinBackBtn').style.display='block'; clearPinInputs(); }
        }
        function showLogin(type) {
            hideAllAuthBoxes();
            if(type==='gesture'){ 
                document.getElementById('gestureBox').style.display='block'; document.getElementById('gestureTitle').textContent='ğŸŒ¸ æ»‘åŠ¨è§£é”'; document.getElementById('gestureBackBtn').style.display='none'; document.getElementById('gestureForgotBtn').style.display='block'; resetGesture();
            } else { 
                document.getElementById('pinBox').style.display='block'; document.getElementById('pinTitle').textContent='ğŸŒ¸ è¾“å…¥PINç '; document.getElementById('pinBackBtn').style.display='none'; document.getElementById('pinForgotBtn').style.display='block'; clearPinInputs();
            }
        }
        function backToChoice() { hideAllAuthBoxes(); document.getElementById('setupBox').style.display = 'block'; }
        function unlockApp() {
            document.getElementById('authOverlay').style.transition = 'opacity 0.5s';
            document.getElementById('authOverlay').style.opacity = 0;
            setTimeout(() => {
                document.getElementById('authOverlay').style.display = 'none';
                document.body.classList.add('unlocked');
                loadFromDB();
            }, 500);
        }

        // æ‰‹åŠ¿é€»è¾‘
        let gesturePath = [], dots = [], ctx, canvas;
        function initGestureCanvas() {
            canvas = document.getElementById('gestureCanvas'); ctx = canvas.getContext('2d');
            const padding = 40, spacing = (canvas.width - padding*2) / 2;
            for(let i=0; i<3; i++) for(let j=0; j<3; j++) dots.push({x: padding + j*spacing, y: padding + i*spacing, index: i*3+j});
            drawGesture();
            let isDrawing = false;
            const start = (e) => { e.preventDefault(); isDrawing=true; gesturePath=[]; checkHit(e); drawGesture(e); };
            const move = (e) => { e.preventDefault(); if(!isDrawing)return; checkHit(e); drawGesture(e); };
            const end = (e) => { e.preventDefault(); if(!isDrawing)return; isDrawing=false; verifyGesture(); drawGesture(); };
            canvas.addEventListener('mousedown', start); canvas.addEventListener('touchstart', start, {passive:false});
            canvas.addEventListener('mousemove', move); canvas.addEventListener('touchmove', move, {passive:false});
            document.addEventListener('mouseup', end); document.addEventListener('touchend', end);
        }
        function drawGesture(e) {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            if(gesturePath.length > 0) {
                ctx.beginPath(); ctx.lineWidth=5; ctx.strokeStyle = '#ff8fa3'; ctx.lineCap='round'; ctx.lineJoin='round';
                const first = dots[gesturePath[0]]; ctx.moveTo(first.x, first.y);
                for(let i=1; i<gesturePath.length; i++) ctx.lineTo(dots[gesturePath[i]].x, dots[gesturePath[i]].y);
                if(e) { const r = canvas.getBoundingClientRect(); const cx = (e.clientX||e.touches[0].clientX)-r.left; const cy = (e.clientY||e.touches[0].clientY)-r.top; ctx.lineTo(cx, cy); }
                ctx.stroke();
            }
            dots.forEach((d, i) => { ctx.beginPath(); ctx.arc(d.x, d.y, 10, 0, Math.PI*2); ctx.fillStyle = gesturePath.includes(i) ? '#ff8fa3' : '#ffe6eb'; ctx.fill(); ctx.strokeStyle = '#ffb7c5'; ctx.lineWidth=2; ctx.stroke(); });
        }
        function checkHit(e) {
            const r = canvas.getBoundingClientRect(); const cx = (e.clientX||e.touches[0].clientX)-r.left; const cy = (e.clientY||e.touches[0].clientY)-r.top;
            dots.forEach((d, i) => { if(!gesturePath.includes(i) && Math.hypot(d.x-cx, d.y-cy) < 30) gesturePath.push(i); });
        }
        function resetGesture() { gesturePath = []; drawGesture(); }
        function verifyGesture() {
            const pat = gesturePath.join('');
            if(authMode==='setup') { if(pat.length<4){alert('è‡³å°‘è¿4ä¸ªç‚¹');resetGesture();return;} tempAuthData.value=pat; showSecuritySetup(); }
            else { if(pat===tempAuthData.value) unlockApp(); else { alert('å›¾æ¡ˆé”™è¯¯'); resetGesture(); } }
        }

        // PINé€»è¾‘
        function focusNext(el, i) { if(el.value.length===1) { if(i<3) document.getElementsByClassName('pin-input')[i+1].focus(); else verifyPin(); } }
        function clearPinInputs() { const ins = document.getElementsByClassName('pin-input'); for(let i=0;i<4;i++) ins[i].value=''; ins[0].focus(); }
        function verifyPin() {
            let pin = ''; const ins = document.getElementsByClassName('pin-input'); for(let i=0;i<4;i++) pin+=ins[i].value;
            if(pin.length!==4) return;
            if(authMode==='setup') { tempAuthData.value=pin; showSecuritySetup(); }
            else { if(pin===tempAuthData.value) unlockApp(); else { alert('å¯†ç é”™è¯¯'); clearPinInputs(); } }
        }

        // å®‰å…¨é—®é¢˜é€»è¾‘
        function showSecuritySetup() { hideAllAuthBoxes(); document.getElementById('securityBox').style.display='block'; document.getElementById('securitySaveBtn').style.display='block'; document.getElementById('securityVerifyBtn').style.display='none'; document.getElementById('securityCancelBtn').style.display='none'; }
        function finishSetup() {
            const q = document.getElementById('secQuestion').value.trim(), a = document.getElementById('secAnswer').value.trim();
            if(!q||!a){alert('è¯·å¡«å†™å®Œæ•´');return;} tempAuthData.question=q; tempAuthData.answer=a;
            const tx=db.transaction(AUTH_STORE_NAME,'readwrite'); tx.objectStore(AUTH_STORE_NAME).put({id:'config',...tempAuthData});
            tx.oncomplete = () => { alert('è®¾ç½®æˆåŠŸï¼'); unlockApp(); };
        }
        function showReset() { authMode='reset'; hideAllAuthBoxes(); document.getElementById('securityBox').style.display='block'; document.getElementById('securityTitle').textContent='ğŸŒ¸ æ‰¾å›å¯†ç '; document.getElementById('securitySaveBtn').style.display='none'; document.getElementById('securityVerifyBtn').style.display='block'; document.getElementById('securityCancelBtn').style.display='block'; document.getElementById('secQuestion').value = tempAuthData.question; document.getElementById('secQuestion').disabled=true; }
        function verifyReset() {
            if(document.getElementById('secAnswer').value.trim() === tempAuthData.answer) {
                alert('éªŒè¯æˆåŠŸï¼Œè¯·é‡æ–°è®¾ç½®');
                const tx=db.transaction(AUTH_STORE_NAME,'readwrite'); tx.objectStore(AUTH_STORE_NAME).delete('config');
                tx.oncomplete=()=>{ authMode='setup'; tempAuthData={}; backToChoice(); document.getElementById('secQuestion').disabled=false; document.getElementById('securityTitle').textContent='è®¾ç½®å®‰å…¨é—®é¢˜'; };
            } else alert('ç­”æ¡ˆé”™è¯¯');
        }
        function cancelReset() { authMode='login'; showLogin(tempAuthData.type); }

        // --- æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ (å¤ç”¨v7) ---
        async function loadFromDB() { const tx=db.transaction(STORE_NAME,'readonly'); const req=tx.objectStore(STORE_NAME).getAll(); req.onsuccess=()=>renderGrid(req.result.sort((a,b)=>new Date(b.date)-new Date(a.date))); }
        async function saveItemToDB(item) { return new Promise((res,rej)=>{ const tx=db.transaction(STORE_NAME,'readwrite'); const req=item.id?tx.objectStore(STORE_NAME).put(item):tx.objectStore(STORE_NAME).add(item); req.onsuccess=()=>res(req.result); req.onerror=rej; }); }
        async function deleteItemFromDB(id) { const tx=db.transaction(STORE_NAME,'readwrite'); tx.objectStore(STORE_NAME).delete(id); return new Promise(r=>tx.oncomplete=r); }
        function renderGrid(data) { const c=document.getElementById('gridContainer'); c.innerHTML=''; if(data.length===0){c.innerHTML='<div class="empty-state">ç©ºç©ºçš„...</div>';return;} data.forEach((item)=>{ const idx=items.indexOf(item); const card=document.createElement('div'); card.className='card'; card.onclick=()=>openDetailModal(idx); 
            const images=item.resources.filter(r=>r.type==='image'); let src=PLACEHOLDER_IMG; if(images.length>0) src=images[item.coverIndex||0]?.content||images[0].content;
            card.innerHTML=`<div class="card-img-wrapper"><img src="${src}"><div class="content-indicators">${getIndicators(item)}</div></div><div class="card-content"><h3 class="card-title">${item.name}</h3><div class="tags-container">${(item.tags||[]).map(t=>`<span class="tag-pill">${t}</span>`).join('')}</div></div>`; c.appendChild(card); }); items=data; renderNavPanel();}
        function getIndicators(item){ const cnt={}; item.resources.forEach(r=>{let t=r.type==='link'?'é“¾æ¥':r.subType; cnt[t]=(cnt[t]||0)+1;}); return Object.keys(cnt).filter(k=>k!=='é»˜è®¤').map(k=>`<div class="indicator">${k} ${cnt[k]}</div>`).join(''); }
        // ... (å…¶ä½™é€»è¾‘ä¿æŒv7ä¸€è‡´ï¼Œä¸ºèŠ‚çœç©ºé—´ç•¥ï¼Œä½†ä¿ç•™äº†å…³é”®åŠŸèƒ½) ...
        function resetAddModal(){ isEditing=false; editingIndex=-1; document.getElementById('modalTitle').textContent='âœ¨ æ·»åŠ æ–°æ”¶è—'; document.getElementById('itemName').value=''; document.getElementById('tagInput').value=''; document.getElementById('linkInputArea').style.display='none'; draftResources=[]; currentTags=[]; renderTagsInput(); renderResourceList(); renderSuggestTags(); }
        function openAddModal(){ resetAddModal(); document.getElementById('addModal').classList.add('active'); }
        function openEditMode(){ if(viewingIndex===-1)return; isEditing=true; editingIndex=viewingIndex; const it=items[editingIndex]; document.getElementById('modalTitle').textContent='âœï¸ ç¼–è¾‘'; document.getElementById('itemName').value=it.name; currentTags=[...(it.tags||[])]; draftResources=JSON.parse(JSON.stringify(it.resources)); renderTagsInput(); renderResourceList(); renderSuggestTags(); document.getElementById('detailModal').classList.remove('active'); document.getElementById('addModal').classList.add('active'); }
        function renderResourceList(){ const l=document.getElementById('resourceList'); l.innerHTML=''; if(draftResources.length===0){l.innerHTML='<div style="text-align:center;color:#ccc;padding:20px">æš‚æ— å†…å®¹</div>';return;} draftResources.forEach((r,i)=>{ const d=document.createElement('div'); d.className='resource-item'; let p=''; if(r.type==='image')p=`<img src="${r.content}" style="width:100%;height:100%;object-fit:cover">`; else if(r.type==='link')p='ğŸ”—'; else p='ğŸ“„'; let s=r.type==='link'?'<span style="font-size:11px;color:#aaa">é“¾æ¥</span>':`<select class="resource-type-select" onchange="updateResourceType(${i},this.value)">${TYPES.map(t=>`<option value="${t}" ${r.subType===t?'selected':''}>${t}</option>`).join('')}</select>`; d.innerHTML=`<div class="resource-preview">${p}</div><div class="resource-info"><div class="resource-name">${r.name}</div>${s}</div><button class="btn-remove" onclick="removeDraftResource(${i})">Ã—</button>`; l.appendChild(d); }); }
        function updateResourceType(i,v){ draftResources[i].subType=v; } function removeDraftResource(i){ draftResources.splice(i,1); renderResourceList(); }
        async function handleImageSelect(inp){ for(let f of inp.files) draftResources.push({type:'image',subType:'é»˜è®¤',name:f.name,content:await readFile(f)}); renderResourceList(); inp.value=''; }
        async function handleJsonSelect(inp){ for(let f of inp.files) draftResources.push({type:'json',subType:'é»˜è®¤',name:f.name,content:await readFileText(f)}); renderResourceList(); inp.value=''; }
        function openLinkInput(){ document.getElementById('linkInputArea').style.display='block'; }
        function confirmAddLink(){ const n=document.getElementById('newLinkName').value.trim(), u=document.getElementById('newLinkUrl').value.trim(); if(n&&u){ draftResources.push({type:'link',subType:'link',name:n,content:u}); renderResourceList(); document.getElementById('linkInputArea').style.display='none'; } else alert('è¯·å¡«å†™å®Œæ•´'); }
        async function saveItem(){ const n=document.getElementById('itemName').value.trim(); if(!n){alert('åå­—ä¸ºç©º');return;} if(draftResources.length===0){alert('å†…å®¹ä¸ºç©º');return;} const d={name:n,tags:[...currentTags],resources:draftResources,coverIndex:0,date:new Date().toISOString()}; if(isEditing){d.id=items[editingIndex].id; d.coverIndex=items[editingIndex].coverIndex;} await saveItemToDB(d); loadFromDB(); closeAddModal(); }
        function openDetailModal(i){ viewingIndex=i; const it=items[i]; document.getElementById('detailName').textContent=it.name; document.getElementById('detailTags').innerHTML=(it.tags||[]).map(t=>`<span class="tag-pill">${t}</span>`).join(''); const imgs=it.resources.filter(r=>r.type==='image'); if(imgs.length===0){document.getElementById('galleryArea').style.display='none';document.getElementById('noImgMsg').style.display='block';}else{document.getElementById('galleryArea').style.display='block';document.getElementById('noImgMsg').style.display='none'; galleryIndex=it.coverIndex||0; if(galleryIndex>=imgs.length)galleryIndex=0; updateGalleryUI(imgs);} const l=document.getElementById('detailListContainer'); l.innerHTML=''; it.resources.forEach((r,idx)=>{ const d=document.createElement('div'); d.className='detail-item'; let ico='ğŸ“„', btn=`<span class="action-link" onclick="downloadResource(${idx})">ä¸‹è½½</span>`, typ=r.subType; if(r.type==='image'){ico='ğŸ–¼ï¸';} else if(r.type==='link'){ico='ğŸ”—';typ='é“¾æ¥';btn=`<a class="action-link" href="${r.content}" target="_blank">æ‰“å¼€</a>`;} d.innerHTML=`<div style="display:flex;align-items:center;min-width:0"><span class="detail-item-type">${typ}</span><span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${ico} ${r.name}</span></div><div style="flex-shrink:0;margin-left:10px">${btn}</div>`; l.appendChild(d); }); document.getElementById('detailModal').classList.add('active'); }
        function updateGalleryUI(imgs){ const img=imgs[galleryIndex]; document.getElementById('detailImg').src=img.content; document.getElementById('galleryTypeLabel').textContent=img.subType; document.getElementById('imgIndex').textContent=galleryIndex+1; document.getElementById('imgTotal').textContent=imgs.length; const btn=document.getElementById('setCoverBtn'); if(galleryIndex===(items[viewingIndex].coverIndex||0)){btn.textContent='å½“å‰å°é¢';btn.classList.add('is-cover');}else{btn.textContent='è®¾ä¸ºå°é¢';btn.classList.remove('is-cover');} }
        function changeGalleryImage(d){ const imgs=items[viewingIndex].resources.filter(r=>r.type==='image'); if(!imgs.length)return; galleryIndex+=d; if(galleryIndex>=imgs.length)galleryIndex=0; if(galleryIndex<0)galleryIndex=imgs.length-1; updateGalleryUI(imgs); }
        async function setAsCover(){ if(viewingIndex===-1)return; items[viewingIndex].coverIndex=galleryIndex; await saveItemToDB(items[viewingIndex]); const imgs=items[viewingIndex].resources.filter(r=>r.type==='image'); updateGalleryUI(imgs); loadFromDB(); }
        function downloadCurrentGalleryImg(){ const imgs=items[viewingIndex].resources.filter(r=>r.type==='image'); if(imgs.length) downloadFile(imgs[galleryIndex].name, imgs[galleryIndex].content); }
        function downloadResource(i){ const r=items[viewingIndex].resources[i]; if(r.type!=='link') downloadFile(r.name, r.content); }
        function downloadFile(n, c){ const a=document.createElement('a'); if(c.startsWith('data:')) a.href=c; else { const b=new Blob([c],{type:'application/json'}); a.href=URL.createObjectURL(b); } a.download=n; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
        function readFile(f){ return new Promise(r=>{const rd=new FileReader(); rd.onload=e=>r(e.target.result); rd.readAsDataURL(f);}); }
        function readFileText(f){ return new Promise(r=>{const rd=new FileReader(); rd.onload=e=>r(e.target.result); rd.readAsText(f);}); }
        function closeAddModal(){document.getElementById('addModal').classList.remove('active');} function closeDetailModal(){document.getElementById('detailModal').classList.remove('active'); viewingIndex=-1;} async function deleteCurrentItem(){ if(confirm('åˆ é™¤?')){ await deleteItemFromDB(items[viewingIndex].id); loadFromDB(); closeDetailModal(); } }
        function handleTagInput(e){if(e.key==='Enter'){e.preventDefault();const v=e.target.value.trim();if(v&&!currentTags.includes(v)){currentTags.push(v);e.target.value='';renderTagsInput();}}}
        function renderTagsInput(){const a=document.getElementById('tagInputArea'),inp=document.getElementById('tagInput'); Array.from(a.children).forEach(c=>c!==inp&&a.removeChild(c)); currentTags.forEach((t,i)=>{const d=document.createElement('div');d.className='tag-chip';d.innerHTML=`${t} <span onclick="currentTags.splice(${i},1);renderTagsInput()">Ã—</span>`;a.insertBefore(d,inp);});}
        function renderSuggestTags(){const s=new Set();items.forEach(i=>(i.tags||[]).forEach(t=>s.add(t))); const b=document.getElementById('suggestedTags'); b.innerHTML=''; s.forEach(t=>{const d=document.createElement('div');d.className='tag-chip';d.style.background='#f0f0f0';d.style.color='#666';d.textContent=t;d.onclick=()=>{if(!currentTags.includes(t)){currentTags.push(t);renderTagsInput();}};b.appendChild(d);});}
        function handleSearch(){const q=document.getElementById('searchInput').value.toLowerCase(); renderGrid(items.filter(i=>i.name.toLowerCase().includes(q)||(i.tags||[]).some(t=>t.toLowerCase().includes(q))));}
        function exportAllData(){const tx=db.transaction(STORE_NAME,'readonly');tx.objectStore(STORE_NAME).getAll().onsuccess=(e)=>{const b=new Blob([JSON.stringify(e.target.result)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=`å¤‡ä»½_${new Date().toISOString().slice(0,10)}.json`;document.body.appendChild(a);a.click();document.body.removeChild(a);}}
        function importAllData(el){const f=el.files[0];if(!f)return;const r=new FileReader();r.onload=e=>{try{const d=JSON.parse(e.target.result);if(Array.isArray(d)){const tx=db.transaction(STORE_NAME,'readwrite');d.forEach(i=>{delete i.id;tx.objectStore(STORE_NAME).add(i);});tx.oncomplete=()=>{loadFromDB();alert('å¯¼å…¥æˆåŠŸ');}}}catch{alert('æ ¼å¼é”™è¯¯');}};r.readAsText(f);}
        function initMusic(){const l=localStorage.getItem('my_bgm_link')||DEFAULT_MUSIC;const a=document.getElementById('bgMusic');a.src=l;a.volume=0.5;document.getElementById('musicLink').value=l;}
        function toggleMusic(){const a=document.getElementById('bgMusic'),b=document.getElementById('playBtn');if(a.paused){a.play();b.textContent='â¸';}else{a.pause();b.textContent='â–¶';}}
        function changeVolume(s){document.getElementById('bgMusic').volume=s.value;}
        function updateMusicSrc(v){if(v){document.getElementById('bgMusic').src=v;localStorage.setItem('my_bgm_link',v);document.getElementById('playBtn').textContent='â–¶';}}
        function renderNavPanel(){const c=document.getElementById('navPanel'),t=c.querySelector('.nav-title');c.innerHTML='';c.appendChild(t);const m={},n=[];items.forEach((it,i)=>{if(!it.tags||!it.tags.length)n.push(i);else it.tags.forEach(g=>{if(!m[g])m[g]=[];m[g].push(i);});});if(n.length)mkGrp(c,'ğŸ“‚ æœªåˆ†ç±»',n);Object.keys(m).sort().forEach(k=>mkGrp(c,`ğŸ·ï¸ ${k}`,m[k]));}
        function mkGrp(c,t,ids){const g=document.createElement('div');g.style.marginBottom='5px';const h=document.createElement('div');h.innerHTML=`${t} â–¾`;h.style.cssText='padding:5px;font-size:12px;font-weight:bold;cursor:pointer;color:#555';h.onclick=()=>{l.style.display=l.style.display==='none'?'block':'none'};const l=document.createElement('div');l.style.cssText='display:none;padding-left:10px';ids.forEach(i=>{const it=document.createElement('div');it.textContent=items[i].name;it.style.cssText='font-size:11px;padding:3px;cursor:pointer;color:#888';it.onclick=()=>{openDetailModal(i);document.getElementById('floatMenu').classList.remove('active');};l.appendChild(it);});g.appendChild(h);g.appendChild(l);c.appendChild(g);}
        function initDraggable(){const w=document.getElementById('floatWidget'),b=document.getElementById('floatBtn'),m=document.getElementById('floatMenu');let drag=false,sx,sy,ix,iy,moved=false;b.addEventListener('mousedown',s);b.addEventListener('touchstart',s,{passive:false});function s(e){if(e.target.closest('.float-menu'))return;drag=false;moved=false;const c=e.type.includes('mouse')?e:e.touches[0];sx=c.clientX;sy=c.clientY;const r=w.getBoundingClientRect();ix=r.left;iy=r.top;w.style.left=ix+'px';w.style.top=iy+'px';w.style.bottom='auto';w.style.right='auto';if(e.type.includes('mouse')){document.addEventListener('mousemove',mv);document.addEventListener('mouseup',ed);}else{document.addEventListener('touchmove',mv,{passive:false});document.addEventListener('touchend',ed);}}function mv(e){const c=e.type.includes('mouse')?e:e.touches[0];const dx=c.clientX-sx,dy=c.clientY-sy;if(Math.abs(dx)>5||Math.abs(dy)>5){drag=true;if(m.classList.contains('active'))m.classList.remove('active');}if(drag){e.preventDefault();w.style.left=(ix+dx)+'px';w.style.top=(iy+dy)+'px';}}function ed(){document.removeEventListener('mousemove',mv);document.removeEventListener('mouseup',ed);document.removeEventListener('touchmove',mv);document.removeEventListener('touchend',ed);}b.addEventListener('click',e=>{if(drag){e.preventDefault();e.stopPropagation();}else{m.classList.toggle('active');}});document.addEventListener('click',e=>{if(m.classList.contains('active')&&!w.contains(e.target))m.classList.remove('active');});}
    </script>
</body>
</html>
