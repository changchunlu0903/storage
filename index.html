<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>âœ¨ æˆ‘çš„ç™¾å®ç®± v8.2 (è¯Šç–—ç‰ˆ) âœ¨</title>
    <style>
        @font-face { font-family: 'MyCustomFont'; src: url('https://files.catbox.moe/cweam3.ttf') format('truetype'); font-display: swap; }
        :root { --primary-color: #ffb7c5; --secondary-color: #ffe6eb; --accent-color: #ff8fa3; --text-color: #6d5c5c; }
        body { font-family: 'MyCustomFont', sans-serif; background-color: var(--secondary-color); color: var(--text-color); margin: 0; padding: 20px; overflow-x: hidden; padding-bottom: 100px; height: 100vh; overflow: hidden; }
        body.unlocked { height: auto; overflow: auto; }
        h1 { text-align: center; color: var(--accent-color); margin: 10px 0 30px 0; font-size: 32px; font-weight: normal;}

        /* ğŸŒ¸ é”å±å±‚ (æœ€é«˜å±‚çº§) */
        #authOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #fff0f5 0%, #ffe6eb 100%); z-index: 99999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .sakura-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
        .sakura { position: absolute; background: #ffb7c5; border-radius: 100% 0 100% 0; animation: fall linear infinite; opacity: 0.7; }
        @keyframes fall { 0% { top: -10%; transform: rotate(0deg); } 100% { top: 110%; transform: rotate(360deg); } }

        /* è®¤è¯æ¡† */
        .auth-box { background: rgba(255,255,255,0.95); padding: 30px; border-radius: 30px; box-shadow: 0 15px 35px rgba(255,183,197,0.3); text-align: center; width: 85%; max-width: 380px; border: 3px solid #fff; position: relative; z-index: 100000; backdrop-filter: blur(5px); }
        .auth-title { color: var(--accent-color); font-size: 24px; margin-bottom: 20px; font-weight: bold; }
        .auth-btn { background: linear-gradient(to right, var(--primary-color), var(--accent-color)); color: white; border: none; padding: 12px 20px; border-radius: 25px; font-size: 16px; width: 100%; margin-top: 15px; box-shadow: 0 5px 15px rgba(255,130,150,0.3); display: block; }
        .auth-btn:active { transform: scale(0.95); opacity: 0.8; }
        
        .pin-input { width: 50px; height: 50px; border: 2px solid var(--primary-color); border-radius: 10px; text-align: center; font-size: 24px; margin: 0 5px; background: #fff; color: var(--accent-color); -webkit-text-security: disc;}
        .switch-link { margin-top: 15px; display: block; color: #888; text-decoration: underline; font-size: 14px; }
        
        #mainContent { display: none; }
        
        /* ç®€å•æ ·å¼é‡ç½® */
        input, select { font-family: inherit; }
        .float-widget { position: fixed; bottom: 30px; right: 30px; z-index: 10000; }
        .float-btn { width: 48px; height: 48px; border-radius: 50%; background: #fff; border: 3px solid var(--primary-color); display: flex; justify-content: center; align-items: center; font-size: 24px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .float-btn::after { content: 'ğŸ¶'; }
        .float-menu { position: absolute; bottom: 60px; right: 0; background: rgba(255,255,255,0.95); padding: 15px; border-radius: 20px; width: 260px; display: none; border: 2px solid #fff; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .float-menu.active { display: block; }
        
        /* é€šç”¨ç±» */
        .card { background: #fff; border-radius: 20px; overflow: hidden; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .card img { width: 100%; height: 200px; object-fit: cover; background: #fcecef; }
        .card-content { padding: 15px; }
        .search-container input { width: 100%; padding: 12px 20px; border-radius: 50px; border: 2px solid #fff; outline: none; box-sizing: border-box; }
        .controls { display: flex; gap: 10px; justify-content: center; margin: 20px 0; flex-wrap: wrap; }
        .controls button { background: #fff; border: 2px solid var(--primary-color); color: var(--accent-color); padding: 8px 15px; border-radius: 20px; font-weight: bold; }
        
        /* å¼¹çª— */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 20000; display: none; justify-content: center; align-items: center; }
        .modal-overlay.active { display: flex; }
        .modal { background: #fff; width: 90%; max-width: 500px; padding: 25px; border-radius: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); border: 2px solid var(--secondary-color); max-height: 80vh; overflow-y: auto; }
        .form-group { margin-bottom: 15px; } label { display: block; margin-bottom: 5px; color: var(--accent-color); }
        input[type="text"], input[type="file"], select { width: 100%; padding: 10px; border: 2px solid var(--secondary-color); border-radius: 10px; box-sizing: border-box; }
        .resource-list { border: 1px solid #eee; padding: 10px; border-radius: 10px; margin-bottom: 10px; max-height: 150px; overflow-y: auto; }
        .resource-item { display: flex; justify-content: space-between; align-items: center; background: #f9f9f9; padding: 5px; margin-bottom: 5px; border-radius: 5px; font-size: 12px; }
    </style>
</head>
<body>

    <div id="authOverlay">
        <div class="sakura-bg" id="sakuraBg"></div>
        
        <div class="auth-box" id="setupBox">
            <div class="auth-title">ğŸŒ¸ æ¬¢è¿</div>
            <div style="margin-bottom:20px; color:#999;">ç¬¬ä¸€æ¬¡æ¥ï¼Œè¯·è®¾ç½®å¯†ç </div>
            <button class="auth-btn" onclick="app.showBox('gestureBox')">è®¾ç½®æ‰‹åŠ¿å¯†ç </button>
            <button class="auth-btn" onclick="app.showBox('pinBox')" style="background: linear-gradient(to right, #a18cd1, #fbc2eb);">è®¾ç½®æ•°å­—å¯†ç </button>
            <div style="margin-top:20px; font-size:12px; color:#ccc;" id="dbStatus">æ•°æ®åº“æ£€æŸ¥ä¸­...</div>
        </div>

        <div class="auth-box" id="gestureBox" style="display:none;">
            <div class="auth-title" id="gTitle">ç»˜åˆ¶å›¾æ¡ˆ</div>
            <canvas id="gestureCanvas" width="300" height="300" style="background:#fff5f7; border-radius:15px;"></canvas>
            <div class="switch-link" onclick="app.showBox('setupBox')">è¿”å›</div>
        </div>

        <div class="auth-box" id="pinBox" style="display:none;">
            <div class="auth-title" id="pTitle">è¾“å…¥4ä½æ•°å­—</div>
            <div style="display:flex; justify-content:center; margin:20px 0;">
                <input type="number" class="pin-input" maxlength="1" id="p1">
                <input type="number" class="pin-input" maxlength="1" id="p2">
                <input type="number" class="pin-input" maxlength="1" id="p3">
                <input type="number" class="pin-input" maxlength="1" id="p4">
            </div>
            <div class="switch-link" onclick="app.showBox('setupBox')" id="pinBack">è¿”å›</div>
            <div class="switch-link" onclick="app.showBox('secBox')" id="pinForgot" style="display:none">å¿˜è®°å¯†ç ?</div>
        </div>

        <div class="auth-box" id="secBox" style="display:none;">
            <div class="auth-title">å®‰å…¨ä¿æŠ¤</div>
            <input type="text" id="qInput" placeholder="é—®é¢˜ (å¦‚: åˆæ‹åå­—)">
            <br><br>
            <input type="text" id="aInput" placeholder="ç­”æ¡ˆ">
            <button class="auth-btn" onclick="app.finishSetup()" id="saveSecBtn">ä¿å­˜å¹¶è¿›å…¥</button>
            <button class="auth-btn" onclick="app.verifyReset()" id="verSecBtn" style="display:none">éªŒè¯å¹¶é‡ç½®</button>
            <div class="switch-link" onclick="location.reload()" id="cancelReset" style="display:none">å–æ¶ˆ</div>
        </div>
    </div>

    <div id="mainContent">
        <h1>ğŸŒ¸ æˆ‘çš„ç™¾å®ç®± ğŸŒ¸</h1>
        
        <div class="float-widget">
            <div class="float-menu" id="fMenu">
                <div style="text-align:center; margin-bottom:10px; color:#aaa; font-size:12px;">ğŸµ éŸ³ä¹æ’­æ”¾</div>
                <input type="text" id="musicUrl" placeholder="MP3é“¾æ¥..." style="font-size:10px; padding:2px; width:90%;">
                <div style="margin-top:5px; display:flex; justify-content:center; gap:10px;">
                    <button onclick="document.getElementById('bgAudio').play()">â–¶</button>
                    <button onclick="document.getElementById('bgAudio').pause()">â¸</button>
                </div>
                <audio id="bgAudio" loop></audio>
                <div style="border-top:1px dashed #eee; margin:10px 0;"></div>
                <div style="font-weight:bold; color:var(--accent-color);">ğŸ·ï¸ å¯¼èˆª</div>
                <div id="navContent"></div>
            </div>
            <div class="float-btn" id="fBtn"></div>
        </div>

        <div class="search-container"><input type="text" id="search" placeholder="æœç´¢..." oninput="app.search()"></div>
        <div class="controls">
            <button onclick="app.openAdd()">â• æ·»åŠ </button>
            <button onclick="app.export()">ğŸ’¾ å¤‡ä»½</button>
            <button onclick="document.getElementById('impFile').click()">ğŸ“‚ å¯¼å…¥</button>
            <input type="file" id="impFile" hidden onchange="app.import(this)">
        </div>
        <div class="grid-container" id="grid"></div>
    </div>

    <div class="modal-overlay" id="editor">
        <div class="modal">
            <h2 id="eTitle">âœ¨ æ·»åŠ </h2>
            <div class="form-group"><label>åå­—</label><input id="eName"></div>
            <div class="form-group"><label>æ ‡ç­¾</label><input id="eTags" placeholder="ç©ºæ ¼åˆ†éš”"></div>
            <div class="form-group">
                <label>æ–‡ä»¶åˆ—è¡¨</label>
                <div class="resource-list" id="eList"></div>
                <div style="display:flex; gap:5px; margin-top:5px;">
                    <button onclick="document.getElementById('addImg').click()" style="font-size:12px">ğŸ–¼ï¸ å›¾ç‰‡</button>
                    <button onclick="document.getElementById('addJson').click()" style="font-size:12px">ğŸ“„ JSON</button>
                    <button onclick="app.addLink()" style="font-size:12px">ğŸ”— é“¾æ¥</button>
                </div>
                <input type="file" id="addImg" hidden multiple accept="image/*">
                <input type="file" id="addJson" hidden multiple accept=".json">
            </div>
            <div style="text-align:right; margin-top:20px;">
                <button onclick="document.getElementById('editor').classList.remove('active')" style="border:none; color:#999;">å–æ¶ˆ</button>
                <button onclick="app.save()" style="background:var(--accent-color); color:white; border:none; padding:8px 20px; border-radius:20px;">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="viewer">
        <div class="modal">
            <h2 id="vName" style="text-align:center;"></h2>
            <img id="vImg" style="width:100%; border-radius:10px; max-height:300px; object-fit:contain; background:#f9f9f9;">
            <div style="display:flex; justify-content:center; gap:10px; margin:10px 0;">
                <button onclick="app.prevImg()">â®</button>
                <button onclick="app.setCover()">è®¾ä¸ºå°é¢</button>
                <button onclick="app.downImg()">â¬‡ï¸</button>
                <button onclick="app.nextImg()">â¯</button>
            </div>
            <div class="resource-list" id="vList"></div>
            <div style="text-align:right; margin-top:20px;">
                <button onclick="app.edit()" style="color:orange; border:none; margin-right:10px;">ç¼–è¾‘</button>
                <button onclick="app.del()" style="color:red; border:none;">åˆ é™¤</button>
                <button onclick="document.getElementById('viewer').classList.remove('active')" style="color:#999; border:none; margin-left:10px;">å…³é—­</button>
            </div>
        </div>
    </div>

<script>
// å…¨å±€åº”ç”¨é€»è¾‘
const app = {
    db: null,
    items: [],
    draft: [],
    currIdx: -1,
    imgIdx: 0,
    tempAuth: {},
    
    init: async function() {
        try {
            // æ¨±èŠ±
            const bg = document.getElementById('sakuraBg');
            for(let i=0;i<15;i++){ let d=document.createElement('div');d.className='sakura';d.style.left=Math.random()*100+'%';d.style.animationDuration=(5+Math.random()*5)+'s';d.style.animationDelay=Math.random()*5+'s';d.style.width=d.style.height=(10+Math.random()*10)+'px';bg.appendChild(d); }
            
            // æ•°æ®åº“
            const req = indexedDB.open('MyMagicBox_v8', 1);
            req.onupgradeneeded = e => {
                const db = e.target.result;
                if(!db.objectStoreNames.contains('data')) db.createObjectStore('data', {keyPath: 'id'});
                if(!db.objectStoreNames.contains('config')) db.createObjectStore('config', {keyPath: 'key'});
            };
            req.onsuccess = e => {
                this.db = e.target.result;
                document.getElementById('dbStatus').innerText = "æ•°æ®åº“è¿æ¥æˆåŠŸ";
                this.checkAuth();
                this.loadData();
            };
            req.onerror = e => {
                alert("æ•°æ®åº“æ‰“å¼€å¤±è´¥ï¼Œå¯èƒ½æ˜¯æµè§ˆå™¨çš„éšç§æ¨¡å¼ç¦æ­¢äº†å­˜å‚¨ã€‚");
                document.getElementById('dbStatus').innerText = "âš ï¸ å­˜å‚¨ä¸å¯ç”¨";
            };

            // ç»‘å®šäº‹ä»¶
            this.bindEvents();
            
        } catch(err) {
            alert("åˆå§‹åŒ–ä¸¥é‡é”™è¯¯: " + err.message);
        }
    },

    bindEvents: function() {
        // PIN è¾“å…¥
        const pins = document.querySelectorAll('.pin-input');
        pins.forEach((p, i) => {
            p.oninput = () => {
                if(p.value.length === 1) {
                    if(i < 3) pins[i+1].focus();
                    else this.checkPin();
                }
            };
        });

        // æ–‡ä»¶ä¸Šä¼ 
        document.getElementById('addImg').onchange = async e => {
            for(let f of e.target.files) this.draft.push({type:'img', name:f.name, content: await this.readFile(f)});
            this.renderDraft();
        };
        document.getElementById('addJson').onchange = async e => {
            for(let f of e.target.files) this.draft.push({type:'json', name:f.name, content: await this.readText(f)});
            this.renderDraft();
        };

        // æ‚¬æµ®çª—
        const btn = document.getElementById('fBtn');
        const menu = document.getElementById('fMenu');
        btn.onclick = () => { menu.classList.toggle('active'); };
        document.addEventListener('click', e => {
            if(!btn.contains(e.target) && !menu.contains(e.target)) menu.classList.remove('active');
        });
    },

    // --- è®¤è¯æ¨¡å— ---
    checkAuth: function() {
        const tx = this.db.transaction('config', 'readonly');
        const req = tx.objectStore('config').get('auth');
        req.onsuccess = e => {
            if(e.target.result) {
                this.tempAuth = e.target.result; // ä¿å­˜çœŸå®å¯†ç 
                this.showLogin();
            } else {
                document.getElementById('setupBox').style.display = 'block';
            }
        };
    },

    showBox: function(id) {
        document.querySelectorAll('.auth-box').forEach(b => b.style.display = 'none');
        document.getElementById(id).style.display = 'block';
        if(id === 'gestureBox') this.initGesture();
    },

    showLogin: function() {
        document.querySelectorAll('.auth-box').forEach(b => b.style.display = 'none');
        if(this.tempAuth.type === 'gesture') {
            document.getElementById('gestureBox').style.display = 'block';
            document.getElementById('gTitle').innerText = 'ğŸŒ¸ æ»‘åŠ¨è§£é”';
            document.querySelector('#gestureBox .switch-link').style.display = 'none';
            // æ·»åŠ å¿˜è®°å¯†ç é“¾æ¥
            if(!document.getElementById('forgotG')) {
                let a = document.createElement('div'); a.id='forgotG'; a.className='switch-link'; a.innerText='å¿˜è®°å¯†ç ?'; 
                a.onclick=()=>this.startReset(); document.getElementById('gestureBox').appendChild(a);
            }
            this.initGesture(true);
        } else {
            document.getElementById('pinBox').style.display = 'block';
            document.getElementById('pTitle').innerText = 'ğŸŒ¸ è¾“å…¥PINç ';
            document.getElementById('pinBack').style.display = 'none';
            document.getElementById('pinForgot').style.display = 'block';
        }
    },

    checkPin: function() {
        let val = '';
        document.querySelectorAll('.pin-input').forEach(p => val += p.value);
        if(val.length !== 4) return;

        if(!this.tempAuth.pass) { // è®¾ç½®æ¨¡å¼
            this.tempAuth.type = 'pin';
            this.tempAuth.pass = val;
            this.showBox('secBox');
        } else { // ç™»å½•æ¨¡å¼
            if(val === this.tempAuth.pass) this.unlock();
            else { alert('å¯†ç é”™è¯¯'); document.querySelectorAll('.pin-input').forEach(p=>p.value=''); }
        }
    },

    initGesture: function(isLogin) {
        const cvs = document.getElementById('gestureCanvas');
        const ctx = cvs.getContext('2d');
        let path = [];
        const pts = [];
        for(let i=0;i<3;i++) for(let j=0;j<3;j++) pts.push({x:50+j*100, y:50+i*100, i:i*3+j});

        const draw = () => {
            ctx.clearRect(0,0,300,300);
            // çº¿
            if(path.length) {
                ctx.beginPath(); ctx.strokeStyle='#ff8fa3'; ctx.lineWidth=5; ctx.lineCap='round';
                ctx.moveTo(pts[path[0]].x, pts[path[0]].y);
                for(let idx of path) ctx.lineTo(pts[idx].x, pts[idx].y);
                ctx.stroke();
            }
            // ç‚¹
            pts.forEach(p => {
                ctx.beginPath(); ctx.fillStyle=path.includes(p.i)?'#ff8fa3':'#ffe6eb';
                ctx.arc(p.x, p.y, 10, 0, Math.PI*2); ctx.fill();
            });
        };
        draw();

        let drawing = false;
        const start = e => { e.preventDefault(); drawing=true; path=[]; };
        const move = e => {
            if(!drawing) return;
            e.preventDefault();
            const rect = cvs.getBoundingClientRect();
            const x = (e.touches?e.touches[0].clientX:e.clientX) - rect.left;
            const y = (e.touches?e.touches[0].clientY:e.clientY) - rect.top;
            pts.forEach(p => {
                if(!path.includes(p.i) && Math.hypot(p.x-x, p.y-y)<30) { path.push(p.i); draw(); }
            });
        };
        const end = () => {
            drawing = false;
            const res = path.join('');
            if(res.length < 4) { alert('è‡³å°‘è¿æ¥4ä¸ªç‚¹'); draw(); return; }
            
            if(!isLogin) { // è®¾ç½®
                this.tempAuth.type = 'gesture';
                this.tempAuth.pass = res;
                this.showBox('secBox');
            } else { // ç™»å½•
                if(res === this.tempAuth.pass) this.unlock();
                else { alert('å›¾æ¡ˆé”™è¯¯'); path=[]; draw(); }
            }
        };

        cvs.ontouchstart = start; cvs.ontouchmove = move; cvs.ontouchend = end;
        cvs.onmousedown = start; cvs.onmousemove = move; cvs.onmouseup = end;
    },

    finishSetup: function() {
        const q = document.getElementById('qInput').value;
        const a = document.getElementById('aInput').value;
        if(!q || !a) { alert('è¯·å¡«å†™å®‰å…¨é—®é¢˜'); return; }
        
        const config = { key: 'auth', type: this.tempAuth.type, pass: this.tempAuth.pass, q: q, a: a };
        const tx = this.db.transaction('config', 'readwrite');
        tx.objectStore('config').put(config);
        tx.oncomplete = () => { alert('è®¾ç½®å®Œæˆï¼'); this.unlock(); };
    },

    unlock: function() {
        document.getElementById('authOverlay').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        document.body.classList.add('unlocked');
    },

    startReset: function() {
        this.showBox('secBox');
        document.getElementById('saveSecBtn').style.display = 'none';
        document.getElementById('verSecBtn').style.display = 'block';
        document.getElementById('cancelReset').style.display = 'block';
        document.getElementById('qInput').value = this.tempAuth.q;
        document.getElementById('qInput').disabled = true;
    },

    verifyReset: function() {
        if(document.getElementById('aInput').value === this.tempAuth.a) {
            alert('éªŒè¯é€šè¿‡ï¼Œè¯·é‡æ–°è®¾ç½®');
            const tx = this.db.transaction('config', 'readwrite');
            tx.objectStore('config').delete('auth');
            location.reload();
        } else {
            alert('ç­”æ¡ˆé”™è¯¯');
        }
    },

    // --- æ•°æ®é€»è¾‘ ---
    loadData: function() {
        const tx = this.db.transaction('data', 'readonly');
        const req = tx.objectStore('data').getAll();
        req.onsuccess = e => {
            this.items = e.target.result;
            this.render();
        };
    },

    render: function() {
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        if(!this.items.length) { grid.innerHTML = '<div class="empty-state">ç©ºçš„...</div>'; return; }
        
        // å€’åº
        [...this.items].reverse().forEach(item => {
            const div = document.createElement('div');
            div.className = 'card';
            div.onclick = () => this.view(item.id);
            
            // æ‰¾å°é¢
            const imgs = item.files.filter(f => f.type === 'img');
            let src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg"/>'; // ç©ºç™½å ä½
            if(imgs.length) src = imgs[item.coverIdx||0]?.content || imgs[0].content;

            div.innerHTML = `
                <div class="card-img-wrapper"><img src="${src}"></div>
                <div class="card-content">
                    <div style="font-weight:bold">${item.name}</div>
                    <div style="font-size:12px; color:#aaa">${new Date(item.date).toLocaleDateString()}</div>
                </div>
            `;
            grid.appendChild(div);
        });
        
        this.updateNav();
    },

    updateNav: function() {
        const nav = document.getElementById('navContent');
        nav.innerHTML = '';
        const tags = new Set();
        this.items.forEach(i => (i.tags||[]).forEach(t => tags.add(t)));
        tags.forEach(t => {
            let d = document.createElement('div');
            d.innerText = '# ' + t;
            d.style.padding = '5px';
            d.onclick = () => { 
                document.getElementById('search').value = t; 
                this.search();
            };
            nav.appendChild(d);
        });
    },

    // æ·»åŠ /ç¼–è¾‘
    openAdd: function() {
        this.currIdx = -1;
        this.draft = [];
        document.getElementById('eTitle').innerText = 'âœ¨ æ·»åŠ ';
        document.getElementById('eName').value = '';
        document.getElementById('eTags').value = '';
        this.renderDraft();
        document.getElementById('editor').classList.add('active');
    },

    addLink: function() {
        const url = prompt("è¾“å…¥é“¾æ¥:");
        if(url) {
            const name = prompt("é“¾æ¥åç§°:", "ç½‘é¡µé“¾æ¥");
            this.draft.push({type:'link', name:name||'é“¾æ¥', content:url});
            this.renderDraft();
        }
    },

    renderDraft: function() {
        const div = document.getElementById('eList');
        div.innerHTML = '';
        this.draft.forEach((f, i) => {
            div.innerHTML += `
                <div class="resource-item">
                    <span>${f.type==='img'?'ğŸ–¼ï¸':(f.type==='link'?'ğŸ”—':'ğŸ“„')} ${f.name}</span>
                    <button onclick="app.draft.splice(${i},1);app.renderDraft()" style="color:red;border:none">Ã—</button>
                </div>
            `;
        });
    },

    save: function() {
        const name = document.getElementById('eName').value;
        if(!name) { alert('å†™ä¸ªåå­—å§'); return; }
        
        const item = {
            id: this.currIdx === -1 ? Date.now() : this.currIdx,
            name: name,
            tags: document.getElementById('eTags').value.split(' ').filter(t=>t),
            files: this.draft,
            date: new Date().toISOString(),
            coverIdx: 0
        };

        const tx = this.db.transaction('data', 'readwrite');
        tx.objectStore('data').put(item);
        tx.oncomplete = () => {
            this.loadData();
            document.getElementById('editor').classList.remove('active');
        };
    },

    // æŸ¥çœ‹
    view: function(id) {
        this.currIdx = id;
        const item = this.items.find(i => i.id === id);
        if(!item) return;

        document.getElementById('vName').innerText = item.name;
        this.imgIdx = item.coverIdx || 0;
        this.renderView(item);
        document.getElementById('viewer').classList.add('active');
    },

    renderView: function(item) {
        const imgs = item.files.filter(f => f.type === 'img');
        const imgEl = document.getElementById('vImg');
        
        if(imgs.length) {
            if(this.imgIdx >= imgs.length) this.imgIdx = 0;
            imgEl.src = imgs[this.imgIdx].content;
            imgEl.style.display = 'block';
        } else {
            imgEl.style.display = 'none';
        }

        const list = document.getElementById('vList');
        list.innerHTML = '';
        item.files.forEach(f => {
            let btn = '';
            if(f.type === 'link') btn = `<a href="${f.content}" target="_blank" style="color:blue">æ‰“å¼€</a>`;
            else btn = `<button onclick="app.downFile('${f.name}')" style="color:green;border:none">ä¸‹è½½</button>`; // ç®€åŒ–ä¸‹è½½é€»è¾‘ï¼Œéœ€è¦é…åˆ downFile å®ç°
            
            // ä¸ºäº†ç®€åŒ–ï¼Œè¿™é‡Œç›´æ¥ç”¨ dataURI ä¸‹è½½
            if(f.type !== 'link') {
               // ä¸´æ—¶æ„å»ºä¸‹è½½é—­åŒ…
               btn = `<a href="${f.content}" download="${f.name}" style="color:green;text-decoration:none">ä¸‹è½½</a>`; 
            }

            list.innerHTML += `
                <div class="resource-item">
                    <span>${f.name}</span>
                    ${btn}
                </div>
            `;
        });
    },

    nextImg: function() {
        const item = this.items.find(i => i.id === this.currIdx);
        const len = item.files.filter(f=>f.type==='img').length;
        if(len) { this.imgIdx = (this.imgIdx+1)%len; this.renderView(item); }
    },
    prevImg: function() {
        const item = this.items.find(i => i.id === this.currIdx);
        const len = item.files.filter(f=>f.type==='img').length;
        if(len) { this.imgIdx = (this.imgIdx-1+len)%len; this.renderView(item); }
    },
    setCover: function() {
        const item = this.items.find(i => i.id === this.currIdx);
        item.coverIdx = this.imgIdx;
        const tx = this.db.transaction('data', 'readwrite');
        tx.objectStore('data').put(item);
        tx.oncomplete = () => { alert('å°é¢å·²æ›´æ–°'); this.loadData(); };
    },
    downImg: function() {
        const item = this.items.find(i => i.id === this.currIdx);
        const imgs = item.files.filter(f => f.type === 'img');
        if(imgs.length) {
            const a = document.createElement('a');
            a.href = imgs[this.imgIdx].content;
            a.download = imgs[this.imgIdx].name;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }
    },

    edit: function() {
        const item = this.items.find(i => i.id === this.currIdx);
        this.draft = JSON.parse(JSON.stringify(item.files));
        document.getElementById('eTitle').innerText = 'âœï¸ ç¼–è¾‘';
        document.getElementById('eName').value = item.name;
        document.getElementById('eTags').value = item.tags.join(' ');
        this.renderDraft();
        document.getElementById('viewer').classList.remove('active');
        document.getElementById('editor').classList.add('active');
    },

    del: function() {
        if(confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ')) {
            const tx = this.db.transaction('data', 'readwrite');
            tx.objectStore('data').delete(this.currIdx);
            tx.oncomplete = () => {
                this.loadData();
                document.getElementById('viewer').classList.remove('active');
            };
        }
    },

    search: function() {
        const val = document.getElementById('search').value.toLowerCase();
        const filtered = this.items.filter(i => i.name.toLowerCase().includes(val) || i.tags.some(t=>t.toLowerCase().includes(val)));
        // æ¸²æŸ“è¿‡æ»¤åçš„åˆ—è¡¨... (ç®€å•èµ·è§é‡æ–°æ¸²æŸ“ itemsï¼Œå®é™…åº”è¯¥åˆ†ç¦»)
        // è¿™é‡Œå·æ‡’ç›´æ¥æ“ä½œ DOM
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        [...filtered].reverse().forEach(item => {
             // ... é‡å¤ render é€»è¾‘ ...
             const div = document.createElement('div');
            div.className = 'card';
            div.onclick = () => this.view(item.id);
            const imgs = item.files.filter(f => f.type === 'img');
            let src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg"/>';
            if(imgs.length) src = imgs[item.coverIdx||0]?.content || imgs[0].content;
            div.innerHTML = `<div class="card-img-wrapper"><img src="${src}"></div><div class="card-content"><div style="font-weight:bold">${item.name}</div></div>`;
            grid.appendChild(div);
        });
    },

    // è¾…åŠ©
    readFile: function(file) {
        return new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = e => resolve(e.target.result);
            reader.readAsDataURL(file);
        });
    },
    readText: function(file) {
        return new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = e => resolve(e.target.result);
            reader.readAsText(file);
        });
    },
    export: function() {
        const blob = new Blob([JSON.stringify(this.items)], {type:'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `backup_${Date.now()}.json`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    },
    import: function(el) {
        const f = el.files[0];
        if(!f) return;
        const reader = new FileReader();
        reader.onload = e => {
            try {
                const data = JSON.parse(e.target.result);
                const tx = this.db.transaction('data', 'readwrite');
                data.forEach(d => tx.objectStore('data').put(d)); // ä½¿ç”¨ put è¦†ç›–æˆ–æ–°å¢
                tx.oncomplete = () => { alert('å¯¼å…¥æˆåŠŸ'); this.loadData(); };
            } catch(err) { alert('æ–‡ä»¶åäº†'); }
        };
        reader.readAsText(f);
        el.value = '';
    }
};

app.init();
</script>
</body>
</html>
